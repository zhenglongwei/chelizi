# 服务商订单详情页

## 基本信息

| 项目 | 说明 |
|------|------|
| 页面路径 | `/pages/merchant/order/detail/index` |
| 页面标识 | 订单详情、接单、更新状态 |
| 载体 | 微信小程序 |
| 入口 | 服务商订单列表点击卡片 |

## 页面功能概述

展示订单完整信息，支持接单（待接单→维修中）、更新状态（维修中→待确认），联系车主等操作。

## 页面布局结构

| 模块 | 说明 |
|------|------|
| 订单状态 | 待接单、维修中、待确认、已完成 |
| 工期计时器 | 待接单/维修中时展示剩余时间 |
| 车辆信息 | 车牌、车型、定损概要 |
| 损伤情况 | 来自定损报告 |
| 报价/维修方案 | 接单前为维修建议，接单后为维修方案（来自 repair_plan 或 quote）；**修改方案**入口（status=1 且 repair_plan_status=0 时） |
| 增值服务 | 来自 repair_plan 或 quote |
| 车主信息 | 联系方式（按规则展示） |
| 维修完成凭证 | status=1 时必填（修复后照片、定损单/结算单、物料照片） |
| 操作按钮 | 接单、维修完成（repair_plan_status=1 时禁用，文案「请等待车主确认维修方案」）、联系车主、撤单申请响应 |

## 功能点详细说明

### 功能点 1：接单

| 项目 | 说明 |
|------|------|
| 功能 ID | F-M-ORD-DETAIL-001 |
| 功能描述 | 服务商接单，订单状态 0→1 |
| 操作流程 | 待接单时点击「接单」→ 确认 |
| 预期结果 | 状态变为维修中；可通知车主 |
| 限制 | 仅 status=0 时显示 |

### 功能点 2：更新为待确认

| 项目 | 说明 |
|------|------|
| 功能 ID | F-M-ORD-DETAIL-002 |
| 功能描述 | 维修完成后，服务商标记为待用户确认 |
| 操作流程 | 维修中时点击「维修完成」→ **必传维修凭证**（修复后照片、定损单/结算单、物料照片各至少 1 张）→ 确认 |
| 预期结果 | 状态变为待确认（2）；凭证存入 orders.completion_evidence；车主端可「确认完成」 |
| 限制 | 仅 status=1 时显示；**repair_plan_status=1（待车主确认）时禁用**，按钮文案「请等待车主确认维修方案」 |
| 凭证要求 | 详见《订单撤单与维修完成流程.md》3.2 节 |

### 功能点 2a：修改维修方案

| 项目 | 说明 |
|------|------|
| 功能 ID | F-M-ORD-DETAIL-002a |
| 功能描述 | 服务商调整维修方案，调整后需车主确认 |
| 操作流程 | status=1 且 repair_plan_status=0 时显示「修改方案」→ 跳转编辑页 → 提交前弹窗确认已通知车主 → 提交 |
| 预期结果 | repair_plan 更新，repair_plan_status=1；创建 user_messages 通知车主；车主端订单详情展示「维修方案已更新，请确认」 |
| 限制 | 配件类型（parts_type）不可修改；详见《维修方案调整与确认流程.md》 |

### 功能点 3：撤单申请响应

| 项目 | 说明 |
|------|------|
| 功能 ID | F-M-ORD-DETAIL-003a |
| 功能描述 | 响应车主发起的撤单申请（仅当接单超过 30 分钟时存在） |
| 操作流程 | 有待处理申请时展示「撤单申请」入口 → 查看理由 → 同意/拒绝 |
| 预期结果 | 同意：订单取消、竞价重开；拒绝：订单保持，通知车主，车主可继续交易或提交人工 |
| 限制 | 仅当存在 status=0 的 order_cancel_requests 时显示 |

### 功能点 4：联系车主

| 项目 | 说明 |
|------|------|
| 功能 ID | F-M-ORD-DETAIL-003 |
| 功能描述 | 拨打电话或通过平台联系 |
| 操作流程 | 点击联系车主 |
| 预期结果 | 调起拨号或客服 |

### 功能点 5：查看报价与车辆信息

| 项目 | 说明 |
|------|------|
| 功能 ID | F-M-ORD-DETAIL-005 |
| 功能描述 | 展示订单关联的报价、车辆、定损信息；**佣金比例、复杂度等级、订单分级** |
| 操作流程 | 进入页面自动加载 |
| 预期结果 | 信息完整展示；佣金按车型分级展示（L1:4%-8%、L2:8%-12% 等） |
| 依赖接口扩展 | 响应含 `commission_rate`、`complexity_level`、`order_tier` |

## 页面参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | string | 是 | 订单 ID（order_id） |

## 交互逻辑

1. **进入页面**：根据 id 加载订单详情，校验是否本店订单。
2. **状态驱动**：根据 status 展示不同操作（接单、维修完成）。
3. **接单**：确认后调用接单接口。
4. **维修完成**：确认后调用更新状态接口。

## 依赖接口

| 接口 | 方法 | 说明 |
|------|------|------|
| /api/v1/merchant/orders/:id | GET | 获取订单详情（含 repair_plan、repair_plan_status） |
| /api/v1/merchant/orders/:id/accept | POST | 接单，status 0→1 |
| /api/v1/merchant/orders/:id/status | PUT | 更新状态，请求体 { status, completion_evidence }；维修完成(1→2)时 completion_evidence 必传；repair_plan_status=1 时禁用 |
| /api/v1/merchant/orders/:id/repair-plan | PUT | 修改维修方案 |
| /api/v1/merchant/orders/:id/cancel-request/:requestId/respond | POST | 服务商响应撤单申请（同意/拒绝） |

## 异常与边界

- 订单不存在或非本店：提示并返回。
- 重复接单：接口幂等或提示已接单。
- 车主已取消：展示已取消，隐藏接单等操作。
- 撤单申请：若该订单有待处理的撤单申请，服务商可响应（同意/拒绝）；同意则订单取消、竞价重开；拒绝则订单保持，通知车主，车主可继续交易或提交人工通道。详见《订单撤单与维修完成流程.md》。
