# 主评价页

> **评价体系基准**：以《评价和激励体系.md》为准，本页整合全链路 4 阶评价中的**前 3 阶**（报价服务、维修过程、完工验收），服务完成后**1 屏到底、1 次提交**。

## 基本信息

| 项目 | 说明 |
|------|------|
| 页面路径 | `/pages/review/submit` |
| 页面标识 | 主评价、完工验收评价 |
| TabBar 位置 | 否 |

## 页面功能概述

**流程触发**：默认在「用户确认维修完工 + 平台完成分账结算」后弹出；后台配置 `require_settlement_before_review=0` 时，平台可提前弹出（提前返现）。不可跳过（可最小化，24 小时内再次打开 APP 强制弹出）。单页 1 屏到底，整合 3 个模块：**模块 1 报价服务**、**模块 2 维修过程**、**模块 3 完工验收**，1 次提交。提交后 **AI 秒级审核**，通过则立即发放基础奖励，不通过则标注缺项、引导补充（无提交次数限制、无惩罚）。

## 页面布局结构

| 模块 | 说明 |
|------|------|
| **顶部合规提示** | 固定展示，不可滚动隐藏：「奖励仅与评价内容的完整性、真实性挂钩，与评价正负倾向完全无关，差评达标也可全额领取奖励」 |
| **系统核验** | 6 项由系统自动核验，用户不答：告知费用、额外项目、服务商一致、结算金额、工期、质保。核验结果进入评价页时展示 |
| **用户必答** | 3 道客观题：进度同步、展示新旧配件、故障已解决；主观描述至少 1 句与项目相关 |
| **维修方案对比** | 当 repair_plan 与 quote 有差异时，展示「原方案（下单时）」vs「最终方案（维修时）」对比 |
| **材料** | 选填。结算清单、完工图、维修过程材料为服务商义务，缺失不影响车主奖励金 |
| **模块 3** | 主观描述、选填 2 维度星级（服务态度、维修环境）；全订单 100% 必填 |
| 奖励金预估 | 按订单分级展示可获奖励金；主评价按当时等级发放；追评可提升等级，差额补发。详见《03-全链路激励驱动体系》2.2 |
| 提交按钮 | 固定在底部，实时显示「必填项完成进度」；必填项未完成时置灰，完成后高亮可点击 |

## 功能点详细说明

### 功能点 1：系统核验（用户不答）

| 项目 | 说明 |
|------|------|
| 功能 ID | F-REVIEW-001 |
| 功能描述 | 6 项由平台根据订单数据自动核验，用户无需作答 |
| 核验项 | 告知费用、额外项目、服务商一致、结算金额、工期、质保 |
| 展示 | 进入评价页时展示核验结果：「报价与结算金额一致、无额外新增项目、服务商一致、工期与质保已核验，无异常」或「部分核验项需关注」 |

### 功能点 2：用户必答（3 道）

| 项目 | 说明 |
|------|------|
| 功能 ID | F-REVIEW-002 |
| 功能描述 | 仅保留系统无法核验、只有车主亲身能感知的内容 |
| 必选客观题 | 1. 维修过程中，修理厂有没有主动给你同步过维修进度？2. 更换配件时，修理厂有没有给你展示新配件、以及换下来的旧配件？3. 修完车之后，你当初报修的车辆问题，已经完全解决了？ |
| 预期结果 | 未完成则无法提交 |

### 功能点 3：材料与完工验收（全订单必填）

| 项目 | 说明 |
|------|------|
| 功能 ID | F-REVIEW-003 |
| 功能描述 | 核心评价环节，奖励发放依据 |
| 必填项 | 3 道客观题 + 至少 1 句与维修项目相关的主观描述 |
| 材料（选填） | 结算清单、完工实拍图、维修过程材料为**服务商义务**，缺失不影响车主奖励金；服务商预填的自动展示，车主可补充 |
| **维修方案对比** | 当 repair_plan 与 quote 有差异时，展示「原方案（下单时）」vs「最终方案（维修时）」对比 |
| 主观描述 | 必填，至少 1 句与项目相关 |
| 选填星级 | 2 维度（服务态度、维修环境），**星级高低不影响奖励发放** |

### 功能点 4：奖励金预估展示

| 项目 | 说明 |
|------|------|
| 功能 ID | F-REVIEW-004 |
| 功能描述 | 按订单分级展示可获奖励金及发放节点 |
| 计算规则 | 奖励金三级校准（复杂度 + 车价 + 维修金额），来自 `GET /api/v1/orders/{id}/reward-preview` |
| 发放节点 | 主评价按当时等级发放；追评提交后若等级升级则差额补发。详见《03-全链路激励驱动体系》2.2 |
| 预期结果 | 提交前显示预估奖励金；提交后显示「奖励金审核中」或「奖励金已到账」 |

## 页面参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| order_id | string | 是 | 订单 ID |

## 服务商凭证与评价预填

服务商维修完成时上传的凭证（`orders.completion_evidence`）在车主评价时**自动预填**到对应模块，**不可删除**，需明确标注「服务商上传」；车主可**新增**照片，标注「车主上传」。

| 服务商凭证 | 评价对应 | 用途 |
|-----------|----------|------|
| 定损单/结算单 | 模块 1、3 | 比较实际项目与预估报价，计算报价准确性（保险才有定损单，否则用结算单） |
| 修复后照片 | 模块 3 完工实拍图 | 与维修项目匹配的完工实拍 |
| 物料照片 | 模块 2 维修过程 | 材料、配件相关 |

详见《订单撤单与维修完成流程.md》3.4 节。

## 交互逻辑

1. **进入页面**：用户点击「确认维修完工」后全屏弹出（是否需等分账完成见流程触发）；根据 `order_id` 加载订单、维修厂、奖励金预估；若订单有 `completion_evidence`，自动预填到对应模块并标注来源。
2. **必填进度**：实时校验各模块必填项，底部按钮显示完成进度；未完成置灰，完成后可点击。
3. **提交评价**：校验必填项 → 调用 `POST /api/v1/reviews` → **AI 秒级审核**。
4. **审核结果**：
   - **通过**：按当时等级发放；追评提交后若等级升级则差额补发。跳转订单详情或个人中心。
   - **不通过**：标注明确缺项，引导用户补充，**无提交次数限制，无惩罚**；用户可修改后重新提交。

## 依赖接口

| 接口 | 方法 | 说明 |
|------|------|------|
| /api/v1/user/orders/{id}/for-review | GET | 获取评价页数据（含 order_verification 系统核验结果） |
| /api/v1/orders/{id}/reward-preview | GET | 奖励金预估 |
| /api/v1/reviews | POST | 提交评价 |
| /api/v1/upload/image | POST | 上传图片 |

## 请求参数示例（提交评价）

```json
{
  "order_id": "string",
  "module2": {
    "materials": ["url1", "url2"]
  },
  "module3": {
    "settlement_list_image": "url",
    "completion_images": ["url1", "url2"],
    "q1_progress_synced": true,
    "q2_parts_shown": true,
    "q3_fault_resolved": true,
    "content": "选填描述",
    "ratings": {
      "service": 5,
      "environment": 5
    }
  },
  "is_anonymous": false
}
```

## for-review 响应扩展

| 字段 | 说明 |
|------|------|
| order_verification | 系统核验结果：{ informed, no_extra_project, shop_match, settlement_match, on_time, warranty_informed } |
| order_verification_all_ok | 是否全部核验通过 |

## 异常与边界

- 订单不存在或已评价：提示并返回。
- 是否需等分账完成：由后台 `require_settlement_before_review` 配置决定，未分账完成时可能禁止评价或允许提前返现。
- 审核不通过：展示缺项说明，用户可补充后重新提交，无次数限制。
- 照片/材料不足：按模块要求提示必传项。
