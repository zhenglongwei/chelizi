# AI 定损页

## 基本信息

| 项目 | 说明 |
|------|------|
| 页面路径 | `/pages/damage/upload` |
| 页面标识 | AI 定损、照片上传定损 |
| TabBar 位置 | 否（可从 TabBar「定损」入口进入） |

## 页面功能概述

用户上传事故车照片，由 AI 分析生成定损报告，并基于报告发起竞价，邀请维修厂报价。

## 页面布局结构

| 模块 | 说明 |
|------|------|
| 照片上传区 | 支持 4–8 张（车身 45 度角、损伤特写、车架号等） |
| 拍摄引导 | 拍摄示例图和文字说明 |
| 车辆信息 | 车牌号、车型、行驶里程等 |
| AI 分析按钮 | 上传完成后点击开始 AI 分析 |
| 分析进度 | 显示进度条 |
| 定损报告 | 损伤部位、维修建议、预估费用；**多车时**支持选择车辆，展示选中车辆的损伤与维修建议 |
| 报告内车辆信息 | 车牌号、品牌、车型（可编辑）；多车时随选中车辆切换 |

## 功能点详细说明

### 功能点 1：照片上传

| 项目 | 说明 |
|------|------|
| 功能 ID | F-DAMAGE-001 |
| 功能描述 | 用户上传事故车照片 |
| 操作流程 | 1. 点击上传区域 2. 选择拍照或从相册选择 3. 图片压缩（最大 5MB） 4. 上传到阿里云 OSS 5. 显示上传进度和缩略图 |
| 预期结果 | 最多 8 张；显示拍摄示例；上传后显示缩略图；支持删除和重新上传 |
| 备注 | 必填：车身 45 度角、损伤特写、车架号；单张不超过 5MB；自动压缩至 1080p |

### 功能点 2：AI 定损分析

| 项目 | 说明 |
|------|------|
| 功能 ID | F-DAMAGE-002 |
| 功能描述 | 调用 AI 分析事故照片，生成损失报告 |
| 操作流程 | 1. 点击「开始 AI 分析」 2. 调用 `/api/v1/damage/analyze` 3. 显示分析进度 4. 分析完成展示结果 |
| 预期结果 | 进度 0–100%；报告含：损伤部位、预估维修项目、参考价格区间 |
| 备注 | 分析约 10–30 秒；失败时提示重新上传；报告仅供参考，以维修厂报价为准 |

### 功能点 3：发起竞价

| 项目 | 说明 |
|------|------|
| 功能 ID | F-DAMAGE-003 |
| 功能描述 | 基于 AI 报告发起竞价 |
| 操作流程 | 1. 确认（可编辑）报告；**多车时**选择己方车辆并确认车牌/品牌/车型 2. 选择竞价范围（5km/10km/全市）、是否走保险 3. 若走保险，选择事故类型及对应保险公司 4. 点击「发起竞价」 5. 系统向符合条件的维修厂推送邀请 6. 跳转竞价报价页 |
| 预期结果 | 发起后跳转报价页，实时显示已报价商家 |
| 备注 | 竞价有效期 24 小时；至少邀请 5 家；用户可随时结束竞价 |

## 页面参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| report_id | string | 否 | 若有已保存报告，可传入继续发起竞价 |
| from | string | 否 | 来源页（如 index、bidding） |

## 交互逻辑

1. **上传照片**：上传 → 校验数量与必填类型 → 压缩 → 上传 OSS → 显示缩略图。
2. **AI 分析**：校验最少张数 → 调用 analyze 接口 → 轮询/SSE 获取进度 → 展示报告。
3. **发起竞价**：校验报告、范围、保险信息 → 调用 create 接口 → 跳转 `/pages/bidding/detail?id={bidding_id}`。
4. **事故类型与保险**：根据是否走保险展示对应选项；选择后带入竞价请求。

## 依赖接口

| 接口 | 方法 | 说明 |
|------|------|------|
| /api/v1/damage/analyze | POST | AI 定损分析 |
| /api/v1/damage/report | POST/GET | 获取定损报告 |
| /api/v1/bidding/create | POST | 发起竞价 |
| /api/v1/upload/image | POST | 上传图片至 OSS |

## 请求参数示例

**发起竞价 insurance_info 结构：**

```json
{
  "is_insurance": true,
  "accident_type": "single|self_fault|other_fault|multi",
  "insurance_company": "string"
}
```

## 异常与边界

- 照片不足/格式异常：提示补充或重拍。
- AI 分析失败：提示重试或重新上传。
- 竞价范围无维修厂：提示扩大范围或换区域。
- 编辑报告：用户可修改 AI 报告内容再发起竞价，修改内容需随竞价一并存储。
