# 车厘子项目 - 故障排查记录

本文档记录项目运行中遇到的典型问题及解决方案，便于后续排查参考。

---

## 1. 千问定损/OCR 报错：Failed to download multimodal content

**时间**：2025年2月

### 现象

- AI 定损分析失败
- 营业执照 OCR 识别失败
- 千问 API 返回：`Failed to download multimodal content`

### 原因

图片 URL 无法被千问服务器访问，导致多模态内容下载失败。根因是**上传目录与 Nginx 配置路径不一致**：

| 环节 | 原错误配置 | 正确配置 |
|------|------------|----------|
| server.js 保存位置 | `/var/www/simplewin/api-server/uploads/` | `/var/www/simplewin/uploads/` |
| Nginx 静态文件路径 | `/var/www/simplewin/uploads/` | `/var/www/simplewin/uploads/` |

server.js 使用 `path.join(__dirname, 'uploads')`，实际保存到 `api-server/uploads`；而 Nginx 将 `/uploads` 映射到项目根下的 `uploads`。请求图片 URL 时 Nginx 返回 404，千问无法拉取图片。

### 解决方案

修改 `web/api-server/server.js`，将上传目录改为项目根下的 `uploads`：

```javascript
// 修改前
const uploadsDir = path.join(__dirname, 'uploads');

// 修改后
const uploadsDir = process.env.UPLOADS_DIR || path.join(__dirname, '..', 'uploads');
```

- `path.join(__dirname, '..', 'uploads')` 在部署时解析为 `/var/www/simplewin/uploads/`
- 可通过 `.env` 的 `UPLOADS_DIR` 覆盖

### 部署后操作

1. 创建目录并授权：
   ```bash
   mkdir -p /var/www/simplewin/uploads
   chown 运行node的用户:组 /var/www/simplewin/uploads
   ```

2. 确认 Nginx 配置中 `/uploads` 指向 `/var/www/simplewin/uploads/`：
   ```nginx
   location /uploads {
       alias /var/www/simplewin/uploads/;
   }
   ```

3. 重启 API 服务

### 验证

- 上传图片后，在浏览器直接访问返回的 URL，应能正常显示
- 定损分析、营业执照 OCR 应能正常完成

### 相关文件

- `web/api-server/server.js`：上传目录配置
- `web/api-server/nginx-upload.conf.example`：Nginx 配置示例

---

## 2. 服务商工作台待报价数量与列表不一致（count=1 但 list 为空）

**时间**：2026年2月

### 现象

- 服务商工作台「待报价」标签显示数量为 1
- 点击进入竞价邀请列表后，列表为空

### 排查过程

1. **数据验证**：确认数据库中存在符合条件的竞价（`biddings.status=0`、`expire_at` 未过期、用户有经纬度、店铺有经纬度、距离在范围内、该店铺未报价）
2. **SQL 直接执行**：在 MariaDB 中执行 count 和 list 的 SQL，均能正确返回 1 条
3. **参数校验**：确认 `merchant_users.shop_id` 与 JWT 中的 `shopId` 一致
4. **根因定位**：问题出在 Node.js 层，而非 SQL 或数据

### 原因

**MySQL/MariaDB 预编译语句中，`LIMIT ?` 和 `OFFSET ?` 使用占位符时可能异常**，导致返回 0 行。直接执行 SQL 正常，但通过 `pool.execute(sql, [..., limit, offset])` 传入参数时，部分环境下会返回空结果。

### 解决方案

将 `LIMIT ? OFFSET ?` 改为字面量拼接，`limit` 和 `offset` 用 `parseInt` 校验后拼接进 SQL：

```javascript
// 修改前（可能返回 0 行）
const listSql = `... ORDER BY created_at DESC LIMIT ? OFFSET ?`;
const [rows] = await pool.execute(listSql, [..., limit, offset]);

// 修改后
const limitNum = Math.min(100, Math.max(1, parseInt(limit, 10) || 10));
const offsetNum = Math.max(0, ((parseInt(page, 10) || 1) - 1) * limitNum);
const listSql = `... ORDER BY created_at DESC LIMIT ${limitNum} OFFSET ${offsetNum}`;
const [rows] = await pool.execute(listSql, [...]);  // 不再传 limit、offset
```

- `limitNum`、`offsetNum` 必须经 `parseInt` 校验，防止 SQL 注入
- 建议统一封装到 `bidding-service.js`，保证 count 与 list 使用同一套筛选逻辑

### 诊断 SQL（便于后续排查）

当 count 与 list 不一致时，可在数据库执行 `web/database/debug-bidding-list.sql` 中的 SQL，对比 count 与 list 的查询结果。

### 相关文件

- `web/api-server/services/bidding-service.js`：竞价列表查询，LIMIT/OFFSET 使用字面量
- `web/database/debug-bidding-list.sql`：竞价列表诊断 SQL
