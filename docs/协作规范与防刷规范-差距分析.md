# 协作规范与防刷规范 - 项目差距分析

> 基于《协作规范.md》《全指标底层逻辑梳理.md》《评价和激励体系》（第四章防刷管理规范）对当前项目实现的对照分析，识别需调整项。

---

## 一、防刷规范 - 需调整项

### 1. 事前防控体系（当前基本未实现）

| 规范要求 | 当前实现 | 差距 |
|----------|----------|------|
| **账号注册与准入风控** | | |
| 强制实名准入、一机一号 | 微信登录，无手机号实名校验 | 需增加手机号实名验证、设备/IP 绑定 |
| 账号分级管理（0-4 级，见《用户等级体系》） | users 表无 trust_level / level | 需新增字段或配置，评价/奖励发放时按等级限制；等级与权重以《用户等级体系.md》为准 |
| 黑名单机制 | 无 blacklist 表 | 需新增 blacklist 表（账号/设备/IP/手机号/身份证），注册/下单/评价前校验 |
| **商户入驻与准入风控** | | |
| 资质强制核验、防多开 | shops 有 compliance_rate 等，无入驻流程校验 | 入驻时需 100% 人工核验、同一法人/地址仅允许一商户 |
| **下单交易环节风控** | | |
| 同用户 30 天内同商户超 3 次 → 冻结 | 选厂下单无任何频次校验 | 需在 `POST /api/v1/bidding/:id/select` 前增加订单频次检查 |
| 新注册 7 天内下单超 5 次 → 冻结 | 无 | 需校验 users.created_at + 近 7 天订单数 |
| 同 IP/设备多账号给同商户下单 | 无 | 需记录 IP/设备指纹，下单时校验 |
| 订单金额与复杂度严重不匹配 | 有 order_tier、complexity_level，无拦截 | 可增加阈值校验（如 L1 订单金额超 1000 元预警/冻结） |
| 最短施工时长（L1≥30 分钟、L2≥2 小时等） | 无 | 需记录维修开始时间，确认完成时校验时长 |

### 2. 事中审核体系（部分实现，多处缺口）

| 规范要求 | 当前实现 | 差距 |
|----------|----------|------|
| **评价准入硬门槛**（以《全指标底层逻辑梳理》2.2 分阶管控为准） | | |
| 交易完成前置 | 已实现：仅 status=3 可评价 | ✓ |
| L1-L2：1–2 张实拍图（新旧配件对比图/施工结果图二选一），无需支付凭证/结算单 | completion_images 可空 | 需按 complexity_level 区分：L1-L2 至少 1 张符合要求的施工图/新旧件对比图 |
| L3-L4：2 张核心图（结果图 + 新旧配件对比图/维修明细单/定损单） | 无分级校验 | 需按 complexity_level 区分：L3-L4 需 2 张核心图，无需支付凭证、全过程施工图 |
| 差评：仅需问题实拍图（L3-L4 另需维修明细单），**无需沟通记录** | 无差评专项校验 | 需对 rating≤2 或负面内容校验问题实拍图，不要求沟通记录 |
| 有效内容门槛（至少 1 句与项目相关描述） | 无 | 需校验 content 与项目相关、非纯套话 |
| **奖励金发放与防刷** | | |
| 合规红线 70% | reward-calculator 已实现 | ✓ |
| L3 主评价 50% + 1 个月追评 50% | 已实现 | ✓ |
| L4 主评价 50% + 1 个月 30% + 3 个月 20% | 已实现 | ✓ |
| L1-L2 可配置冻结 7 天 | 评价通过后立即发放 | 需增加冻结期配置，7 天后无异常再发放 |
| **特殊场景** | | |
| 同一用户每月 L1 奖励金封顶 100 元 | 无 | 需在发放前累计当月 L1 奖励金，超 100 元则截断 |
| 同一店铺 L1 好评每月权重上限 100 | 无权重体系 | 与第三阶段权重体系一并实现 |

### 3. 差异化权重管控体系（未实现）

| 规范要求 | 当前实现 | 差距 |
|----------|----------|------|
| 店铺最终评价得分（加权平均） | shops.rating 为简单平均或手动维护 | 需按规范公式计算：Σ(星级×权重)/Σ(权重) |
| 单条权重 = 订单含金量×内容质量×账号可信度×合规系数 | 无 | 需实现权重计算逻辑，写入 reviews 或单独表 |
| 评价时间衰减（3 个月 100%、3-6 月 50%等） | 无 | 需在得分计算时应用衰减 |
| 差评权重 ×1.5（L1-L2）、×2（L3-L4） | 无 | 需在权重公式中体现 |

### 4. 事后追责与违规处理（未实现）

| 规范要求 | 当前实现 | 差距 |
|----------|----------|------|
| 违规分级处理（一级～四级） | 无 | 需定义违规类型与处罚标准 |
| 黑名单、封号、冻结款项 | 无 | 需黑名单表、users.status 封禁、transactions 冻结机制 |
| 申诉与复核机制 | 无 | 需申诉入口、24 小时复核流程 |
| 全流程审计留痕 | review_audit_logs 有基础记录 | 需扩展至订单、违规处理、规则修改等 |

### 5. 配套防刷运营后台（部分实现）

| 规范要求 | 当前实现 | 差距 |
|----------|----------|------|
| 模块 1 防刷基础规则配置中心 | RewardRulesConfig 仅有奖励金/佣金 | 需新增：账号风控、订单风控、评价审核、违规处罚、L1 封顶、冻结期等配置 |
| 模块 2 智能风控引擎 | 无 | 需实时风控、内容反作弊、凭证核验、风险预警 |
| 模块 3 评价审核管理中心 | ReviewAudit 有基础列表与人工复核 | 需必审池、抽检池、申诉管理、破格升级分配 |
| 模块 4 商户合规管理中心 | MerchantManagement 有基础信息 | 需合规档案、等级自动更新、处罚执行 |
| 模块 5 违规处理与审计中心 | 无 | 需违规订单管理、审计日志、黑名单统一管理 |
| 模块 6 防刷数据报表 | DataStatistics 有基础统计 | 需违规分析、风控效果、奖励金风控等报表 |

---

## 二、协作规范 - 变更记录对照

### 已实现项 ✓

| 项 | 说明 |
|----|------|
| 数据库迁移 | migration-20260211-evaluation-system.sql 已包含 |
| settings 配置 | require_settlement_before_review 等已插入 |
| orders 扩展 | order_tier、complexity_level、reward_preview、review_stage_status |
| reward-preview 接口 | 已实现 |
| reviews 扩展 | 3 模块、settlement_list_image、completion_images、objective_answers |
| followup 扩展 | stage: 1m/3m |
| user/balance 扩展 | reward_tier、review_stage、tax_deducted |
| A10 奖励金规则配置 | RewardRulesConfig 已实现 |
| A11 评价审核 | ReviewAudit 已实现 |
| A12 破格升级审核 | ComplexityUpgrade 已实现 |
| 合规红线 70% | reward-calculator 已实现 |
| 追评 1 个月/3 个月 | 已实现 |

### 待确认/待完善项

| 项 | 说明 |
|----|------|
| require_settlement_before_review | 迁移脚本已插入，但评价接口未读取该配置做分账前置校验 |
| shops 排序脱钩 | 维修厂列表/详情排序逻辑需确认是否与 rating 脱钩（规范 3.5.2） |
| 分账完成才允许评价 | 若配置为 1，需在评价前校验分账状态 |

---

## 三、落地优先级建议（按防刷规范三阶段）

### 第一阶段（冷启动期，优先上线）

1. **订单风控**：选厂下单前校验「同用户 30 天内同商户 ≤3 次」「新用户 7 天内 ≤5 次」
2. **评价凭证强制**：L1-L2 必须 settlement_list_image + completion_images（至少 2 张），否则驳回
3. **L1 每月奖励金封顶 100 元**：发放前累计当月 L1 奖励金，超则截断
4. **合规红线**：已实现，保持
5. **奖励金发放节点**：已实现，保持

### 第二阶段（成长期）

1. 黑名单表 + 注册/下单/评价前校验
2. 账号分级（简化版：新用户/普通/核心可信）
3. 差异化权重体系（店铺得分计算）
4. 防刷规则配置中心（L1 封顶、冻结期、订单风控阈值等）
5. 评价审核必审池、抽检池

### 第三阶段（成熟期）✅ 已实现

1. **内容反作弊**：评价重复度检测、无意义水评拦截（antifraud.checkContentAntiCheat）
2. **违规处理与审计中心**：violation_records、audit_logs 表，违规登记、三级/四级自动封号+黑名单，审计日志
3. **定损单对接**：antifraud.verifyInsuranceClaim 占位接口，待对接保险公司
4. **防刷数据报表**：GET /api/v1/admin/antifraud/statistics，防刷管理页「防刷报表」Tab

---

## 四、具体代码/配置调整清单

| 序号 | 文件/模块 | 调整内容 | 状态 |
|------|-----------|----------|------|
| 1 | `web/api-server/server.js` | 选厂下单前增加：同用户 30 天同商户订单数、新用户 7 天订单数校验 | ✅ 已实现 |
| 2 | `web/api-server/server.js` | 评价提交时：L1-L2 强制 settlement_list_image + completion_images 至少 2 张 | ✅ 已实现 |
| 3 | `web/api-server/server.js` | 奖励金发放前：L1 订单累计当月奖励金，超 100 元截断 | ✅ 已实现 |
| 4 | `web/database/migration-20260215-phase2-antifraud.sql` | 新增 blacklist 表、防刷配置 | ✅ 已实现 |
| 5 | `web/database/schema.sql` | 新增 users.risk_level 或类似字段（可选） | 暂不实现，账号可信度按规则动态计算 |
| 6 | `web/src/admin/pages/AntiFraudManagement.tsx` | 防刷规则配置、黑名单管理 | ✅ 已实现 |
| 7 | `web/api-server/server.js` | 读取 require_settlement_before_review，若为 1 则评价前校验分账状态 | 待完善 |
| 8 | `web/api-server/server.js` | 维修厂列表/详情接口：确认排序逻辑与 rating 脱钩 | 待确认 |

---

## 五、修订记录

| 版本 | 日期 | 说明 |
|------|------|------|
| v1.0 | 2026-02-15 | 初稿，基于协作规范与防刷规范对照项目实现 |
