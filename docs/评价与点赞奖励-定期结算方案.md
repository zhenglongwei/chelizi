# 评价与点赞奖励 - 定期结算方案

> **定位**：补齐《03-全链路激励驱动体系》《04-点赞追加奖金体系》中「评价升级差额补发」「点赞追加奖金」的发放方式，明确结算周期与实现路径。
>
> **已确认**：每月 10 日结算，到账预留 1～3 个工作日，全部定期结算，用户须有详细清单；可分阶段上线。

---

## 一、需纳入定期结算的奖励类型

| 奖励类型 | 来源文档 | 触发条件 | 当前实现 |
|----------|----------|----------|----------|
| **评价升级差额补发** | 03 §2.2 | 追评提交后整体重评，内容等级升级 | ✅ 已实现（待结算表+月度发放） |
| **常规点赞追加** | 04 §3.1 | 当月新增有效点赞 × 账号综合权重系数 | ✅ 已实现（月度结算） |
| **内容转化追加** | 04 §3.2 | 7 天窗口内点赞 → 用户成交 → 按决策权重分配 | ✅ 已实现（月度结算） |
| **事后验证补发** | 04 §3.3 | 修车后回头点赞，满足 5 项判定 | ✅ 已实现（待结算表+月度发放） |

**说明**：主评价基础奖励、追评阶段奖励（1m/3m）保持**实时发放**，不纳入定期结算。

---

## 二、结算周期方案对比

### 方案 A：每月固定日期定期结算（推荐）

| 项目 | 说明 |
|------|------|
| **结算日** | 每月固定日期（如每月 5 日），结算上一自然月应得奖励 |
| **核算范围** | 上月 1 日 00:00 ～ 上月最后一日 23:59 产生的：评价升级差额、常规点赞追加、内容转化追加、事后验证补发 |
| **发放时机** | 结算任务跑完后 1～3 个工作日内到账（可配置） |
| **优点** | 规则清晰、便于对账、减少实时计算压力、利于风控事后复核 |
| **缺点** | 用户需等待至次月，体验略滞后 |

### 方案 B：实时结算

| 项目 | 说明 |
|------|------|
| **结算日** | 事件发生时立即计算并发放 |
| **核算范围** | 追评整体重评完成 → 差额补发；点赞发生 → 常规点赞追加；成交发生 → 内容转化/事后验证 |
| **优点** | 即时反馈，用户体验好 |
| **缺点** | 内容转化需等 7 天窗口期结束才能确定；事后验证需等完工后 30 天内点赞；实时计算与风控复核压力大 |

### 方案 C：混合模式

| 奖励类型 | 结算方式 | 理由 |
|----------|----------|------|
| 评价升级差额补发 | **实时** | 事件明确、金额可即时计算，补发逻辑简单 |
| 常规点赞追加 | **月度** | 需汇总当月点赞，批量核算更清晰 |
| 内容转化追加 | **月度** | 7 天窗口期 + 多评价权重分配，适合批量 |
| 事后验证补发 | **月度** | 需结合完工时间、浏览记录等，批量更易复核 |

### 方案 D：双周结算

| 项目 | 说明 |
|------|------|
| **结算日** | 每月 15 日、月末，结算前两周应得奖励 |
| **优点** | 比月度更频繁，等待时间缩短 |
| **缺点** | 内容转化 7 天窗口、事后验证 30 天窗口与双周边界不天然对齐，规则略复杂 |

---

## 三、推荐结论与理由

**推荐采用方案 A：每月固定日期定期结算**，理由如下：

1. **与您判断一致**：定期结算更利于规则透明、对账清晰、风控复核。
2. **统一口径**：所有「滞后型」奖励（评价升级差额、点赞追加、内容转化、事后验证）统一月度结算，用户心智简单：「每月 X 号发上月奖励」。
3. **技术实现**：单次定时任务批量跑完，便于日志、对账、异常重跑。
4. **合规与风控**：04 文档强调「滞后结算、违规追溯」，月度结算天然留出复核窗口。

**可选优化**：若希望评价升级差额补发更快到账，可单独采用**方案 C 的混合模式**——差额补发实时、点赞相关月度。实现复杂度略增，但体验更好。

---

## 四、实现计划（按方案 A 假设）

### 4.1 结算任务设计

| 步骤 | 内容 |
|------|------|
| 1 | 每月 10 日凌晨执行 `cron-settle-monthly-rewards.sh` |
| 2 | 任务调用 API 或内部服务：`POST /internal/settle-monthly-rewards?month=YYYY-MM` |
| 3 | 服务按顺序执行：① 评价升级差额 ② 常规点赞追加 ③ 内容转化追加 ④ 事后验证补发 |
| 5 | 每类奖励写入 `transactions`，`type` 区分：`upgrade_diff` / `like_bonus` / `conversion_bonus` / `post_verify_bonus`；`description` 存计算依据，供清单展示 |
| 6 | 更新 `users.balance`、`users.total_rebate` |
| 7 | 写入结算日志表，便于对账与重跑 |
| 8 | 结算完成后 1～3 个工作日内到账（可配置）；用户可查看详细清单 |

### 4.2 核算逻辑概要

**① 评价升级差额补发**

- 查询：上月内 `reviews` 有追评提交、且 `recomputeHolisticContentQuality` 已跑完、`content_quality_level` 较主评价首次发放时升级的记录。
- 计算：`补发 = 升级后总奖金（基础 + 新等级浮动）− 已发奖金`。
- 约束：仍受 70% 佣金红线、单订单总封顶约束。

**② 常规点赞追加**

- 查询：上月 `review_likes` 中 `is_valid_for_bonus=1` 且 `created_at` 在上月内的记录。
- 公式：`单条 = 订单实收佣金 × 0.5% × Σ(账号综合权重系数)`，按评价维度汇总。
- 约束：基础 + 追评差额 + 常规点赞 ≤ 实收佣金 80%。

**③ 内容转化追加**

- 查询：上月内完成的订单，回溯 7 天内点赞过相关评价的有效点赞，按决策权重分配内容转化奖金池（佣金 50%）。
- 约束：单笔最多 10 条分配；超额不纳入 80% 封顶。

**④ 事后验证补发**

- 查询：上月内满足「下单前 7 天有浏览 + 同品牌同车系同类项目真实交易 + 完工后 30 天内点赞」的点赞。
- 补发：该笔成交未给其他评价分配过时，从奖金池划出 50% 补发。

### 4.3 数据库与配置

| 变更 | 说明 |
|------|------|
| `transactions.type` | 扩展：`upgrade_diff`、`like_bonus`、`conversion_bonus`、`post_verify_bonus` |
| `reward_settlement_logs`（可选） | 记录每次结算任务：month、各类型金额、状态、重跑标记 |
| `settings` | 新增 `monthly_settlement_day`（10）、`settlement_delay_days`（1～3）等配置 |

### 4.4 前置依赖

| 依赖 | 状态 |
|------|------|
| 追评整体重评 + 差额计算逻辑 | ✅ 已实现 |
| 订单分级封顶、低端车型封顶上浮 | ✅ 已实现 |
| 常规点赞追加核算公式 | ✅ 已实现（含 80% 封顶） |
| 内容转化追加（7 天窗口 + 决策权重） | ✅ 已实现 |
| 事后验证判定与补发 | ✅ 已实现（含 post_verify_settled_orders 防重复） |

### 4.5 分阶段上线

| 阶段 | 纳入结算的奖励 | 说明 |
|------|----------------|------|
| 第一阶段 | 评价升级差额补发、常规点赞追加 | ✅ 已上线 |
| 第二阶段 | 内容转化追加、事后验证补发 | ✅ 已接入同一结算任务 |

---

## 五、已确认事项（2026-02）

| 事项 | 结论 |
|------|------|
| 结算日 | **每月 10 日** |
| 到账延迟 | **预留 1～3 个工作日**复核后到账 |
| 混合模式 | **不采用**，全部定期结算 |
| 用户清单 | **必须有详细清晰的结算清单**，见 5.1 |
| 分阶段上线 | **可**，先上线评价升级差额 + 常规点赞追加，其余后续接入 |

### 5.1 用户结算清单（强制要求）

每月结算完成后，用户可在「奖励金明细」或「月度结算单」中查看**逐条明细**，格式如下：

| 字段 | 说明 |
|------|------|
| 结算月份 | 如 2026-01 |
| 奖励类型 | 评价升级差额 / 常规点赞追加 / 内容转化追加 / 事后验证补发 |
| 关联评价 | 评价 ID 或摘要（如「XX 店 L3 维修评价」） |
| 关联订单 | 订单 ID（若有） |
| 计算依据 | 可追溯的简要说明（如「1 级→2 级，补发 15 元」「3 个有效点赞，权重和 2.5」） |
| 税前金额 | 元 |
| 个税扣减 | 元（>800 部分 20%） |
| 实发金额 | 元 |
| 结算时间 | 到账时间 |

**清单粒度**：每条 `transactions` 记录对应清单一行，用户可按月筛选、按类型筛选。

---

## 六、文档同步

- 已同步更新：
  - `docs/体系/03-全链路激励驱动体系.md`：补充结算周期说明
  - `docs/体系/04-点赞追加奖金体系.md`：将「发放方式待定」改为「每月 10 日定期结算」
