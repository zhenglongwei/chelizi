# 维修方案调整与确认流程

版本：v1.0  
日期：2026-02-23  
基于：用户需求澄清

---

## 1. 业务背景

- 接单后，原「维修建议」（来自报价）升级为正式「维修方案」
- 车辆到店、拆车等过程中可能发现更多损伤，服务商可调整方案
- 调整后需车主确认，确认前服务商不能点击「维修完成」
- 初始方案（= 报价）无需再次确认，接单即视为车主已同意

---

## 2. 流程概览

```
接单 → 维修方案 = 报价（已确认）
       ↓
    车辆到店、拆车发现更多
       ↓
    服务商修改方案（修改前须先通知车主）
       ↓
    提交调整 → 维修方案待确认
       ↓
    车主端收到通知（站内消息 + 红点）
       ↓
    车主同意 → 服务商可点击「维修完成」
    车主不同意 → 平台介入
```

---

## 3. 数据模型

### 3.1 订单表扩展（orders）

| 字段 | 类型 | 说明 |
|------|------|------|
| repair_plan | JSON | 当前维修方案 `{ items, value_added_services?, amount?, duration?, warranty? }`，接单时从 quote 复制，调整时更新 |
| repair_plan_status | TINYINT | 0=已确认（无调整或车主已同意）1=待车主确认 |
| repair_plan_adjusted_at | DATETIME | 最近一次调整时间 |

- 接单时：`repair_plan` = 从 quote 复制，`repair_plan_status` = 0
- 调整时：更新 `repair_plan`，`repair_plan_status` = 1，`repair_plan_adjusted_at` = now
- 车主同意时：`repair_plan_status` = 0

### 3.2 维修方案 items 结构

与 quote.items 一致：`[{ damage_part, repair_type, parts_type? }]`

**约束**：同一项目（按 damage_part 匹配）的 `parts_type` 不可修改。例如原为「原厂配件」，调整后仍须为「原厂配件」。

---

## 4. 接口设计

### 4.1 服务商修改维修方案

```
PUT /api/v1/merchant/orders/:id/repair-plan
Body: { items, value_added_services?, amount?, duration?, warranty? }
```

- 仅 status=1（维修中）时可调用
- 校验：原 items 中已有项目的 parts_type 不可变更
- 成功后：创建 user_messages（type=order，引导车主确认）；生成公众号消息（预留，格式待定）

### 4.2 车主确认维修方案

```
POST /api/v1/user/orders/:id/repair-plan/approve
Body: { approved: true | false }
```

- approved=true：`repair_plan_status` = 0，可通知服务商
- approved=false：记录拒绝，提示「请联系客服处理」（平台介入）

---

## 5. 页面与交互

### 5.1 服务商订单详情（M07）

| 改动 | 说明 |
|------|------|
| 文案 | status≥1 时「维修建议」改为「维修方案」 |
| 修改方案 | 新增「修改方案」入口，仅 status=1 且 repair_plan_status=0 时显示 |
| 修改前提示 | 弹窗：「修改前请先通知车主，沟通后再提交。确认已通知？」 |
| 修改表单 | 支持增删改 items、金额、工期、质保；parts_type 不可改（UI 禁用或校验） |
| 维修完成 | repair_plan_status=1 时，「维修完成」按钮禁用，提示「请等待车主确认维修方案」 |

### 5.2 车主订单详情

| 改动 | 说明 |
|------|------|
| 维修方案 | 展示 repair_plan（与报价结构一致） |
| 待确认 | repair_plan_status=1 时展示「维修方案已更新，请确认」+「同意」「不同意」 |
| 不同意 | 提示「如有疑问请联系客服」，记录状态供平台介入 |

### 5.3 订单列表（服务商 + 车主）

| 改动 | 说明 |
|------|------|
| 第二行 | status=1 且 repair_plan_status=1 时，在状态下方显示「维修方案待确认」 |
| 样式 | 使用 `--warning`（#F59E0B）或 `--danger`（#EF4444），符合设计规范中「待处理」类提示 |

### 5.4 报价免责提示（车主查看报价时）

| 位置 | 说明 |
|------|------|
| 竞价报价页 | `/pages/bidding/detail` 报价列表、报价明细、确认选择弹窗 |
| 文案 | 在报价单/报价明细旁增加：「此报价仅供参考，以实际维修时为准」 |
| 样式 | 使用 `--text-hint` 或 `--text-secondary`，字号 `fs-cap`，不抢主视觉 |

---

## 6. 评价中的方案对比（维修过程维度）

### 6.1 业务说明

维修方案若有调整（repair_plan 与 quote 不一致），方案前后变化应体现在订单评价中，作为**模块 2 维修过程**的一部分，帮助车主在评价时了解维修过程的透明度。

### 6.2 实现方式

| 项目 | 说明 |
|------|------|
| 展示位置 | 主评价页 `/pages/review/submit`，**模块 2 维修过程**内 |
| 展示条件 | 订单存在维修方案调整（即 `repair_plan` 与原始 `quote` 有差异）时展示 |
| 展示内容 | 方案前后对比：原方案（quote） vs 最终方案（repair_plan），突出增删改项 |
| 数据来源 | 原方案：`orders.quote_id` → `quotes` 表；最终方案：`orders.repair_plan` |
| 用途 | 供车主评价「维修项目与报修故障对应」「是否同步进度」等客观题时参考；体现服务商调整方案的透明度 |

### 6.3 与现有维修过程模块的关系

- 模块 2 现有：材料上传 + 3 道客观题（配件型号一致、项目与故障匹配、是否同步进度）
- 方案对比作为**补充展示**，置于材料上传区上方或客观题前，仅在有调整时显示

---

## 7. 通知

### 7.1 公众号（预留）

- 服务商提交调整后，生成一条消息记录（格式待公众号开发时对接）
- 用于将用户引导至小程序

### 7.2 小程序站内消息 + 红点

- 写入 `user_messages`：type=order，title 如「维修方案已更新」，content 简要说明，related_id=order_id
- 车主端消息中心红点 +1，进入订单详情可确认

---

## 8. 边界与异常

| 场景 | 处理 |
|------|------|
| 车主不同意 | 记录状态，提示联系客服，平台人工介入 |
| 重复提交 | 若 repair_plan_status=1，服务商可再次修改并覆盖，视为重新提交 |
| 配件类型篡改 | 接口校验，拒绝并返回错误 |

---

## 9. 实施顺序建议

1. 数据库迁移（orders 新增字段）
2. 后端接口（修改方案、确认方案）
3. 服务商端：订单详情修改方案入口 + 表单 + 维修完成禁用逻辑
4. 车主端：订单详情确认入口 + 同意/不同意
5. 订单列表：第二行「维修方案待确认」展示
6. 站内消息创建与红点
7. **报价免责提示**：竞价报价页报价单旁增加「此报价仅供参考，以实际维修时为准」
8. **评价方案对比**：主评价页模块 2 维修过程中，有调整时展示方案前后对比

---

请确认以上方案是否符合预期，确认后再开始实施。
