# 竞价单分发机制 - 实施计划（已确认版）

> 基于《07-竞价单分发机制.md》，整合用户确认后的完整实施计划。

---

## 一、已确认事项

### 1. 新开店铺

- **新店定义**：90 天，**可配置**
- **新店基础分**：60，**可配置**
- 策略：默认值 + 新店豁免能力门槛 + 基础分参与梯队划分

### 2. 配置入口

- **并入现有系统配置页**，不单独建页

### 3. 产能

- **首期不校验**，预留开关

### 4. 资质校验

- **参考《修理厂资质等级和维修复杂度之间的关系.md》**，按法定对应关系执行：
  - L1：三类专项 / 二类 / 一类
  - L2：二类 / 一类全量；三类仅对应专项
  - L3：仅二类 / 一类，三类不可
  - L4：仅一类，二类 / 三类不可

### 5. 推送

- **待报价查询**按梯队过滤 ✓
- **需要推送**：预留公众号消息推送；小程序 `merchant_messages` 红点提示

### 6. 同项目完单（精确到项目 + 按复杂度分层）

- **原则**：高复杂度项目才有参考价值，低复杂度仅作兜底
- **示例**：仅补漆(L2) → 任意补漆完单即可；补漆+发动机(L4) → 优先匹配发动机完单，找不到再参考补漆
- **数据来源**：竞价 `repair_suggestions` / `damages` + `repair_complexity_levels`；历史完单 `quotes.items` / `repair_plan`

---

## 二、可配置项（并入现有配置）

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| **硬门槛** | | |
| `filterComplianceMin` | 80 | 合规率最低要求（%） |
| `filterViolationDays` | 30 | 重大违规统计天数 |
| `filterCapacityCheck` | false | 是否启用产能校验（首期无数据源可关） |
| **兜底** | | |
| `fallbackDistanceExpandRate` | 0.2 | 距离不足 3 家时每次扩大幅度（20%） |
| `fallbackMinShops` | 3 | 兜底最少店铺数 |
| **梯队** | | |
| `tier1MatchScoreMin` | 80 | 第一梯队综合匹配分下限 |
| `tier1ComplianceMin` | 95 | 第一梯队合规率下限 |
| `tier2MatchScoreMin` | 60 | 第二梯队综合匹配分下限 |
| `tier2MatchScoreMax` | 79 | 第二梯队综合匹配分上限 |
| `tier2ComplianceMin` | 85 | 第二梯队合规率下限 |
| `tier1ExclusiveMinutes` | 15 | 第一梯队独家推送窗口（分钟） |
| `tier3MaxShops` | 2 | 第三梯队最多分发家数 |
| **分发数量** | | |
| `distributeL1L2Max` | 10 | L1–L2 最多分发家数 |
| `distributeL1L2ValidStop` | 5 | L1–L2 有效报价满 N 家停止 |
| `distributeL3L4Max` | 15 | L3–L4 最多分发家数 |
| `distributeL3L4ValidStop` | 8 | L3–L4 有效报价满 N 家停止 |
| **新店** | | |
| `newShopDays` | 90 | 新店定义：注册天数 ≤ N |
| `newShopBaseScore` | 60 | 新店综合匹配分默认值 |
| **同项目完单量分** | | |
| `sameProjectScorePriority` | 15 | 优先匹配（高复杂度项目）的满分档加分 |
| `sameProjectScoreFallback` | 5 | 兜底匹配（低复杂度项目）的满分档加分 |

---

## 三、资质校验细则（按《修理厂资质等级和维修复杂度之间的关系》）

| 竞价复杂度 | 法定最低资质 | 平台落地规则 |
|------------|--------------|--------------|
| L1 | 三类对应专项 / 二类 / 一类 | 三类：`shops.categories` 或专项资质与项目匹配；二类/一类全量 |
| L2 | 二类 / 一类全量；三类对应专项 | 三类：专项资质与项目匹配（如钣金喷漆专项→钣金喷漆项目） |
| L3 | 二类及以上 | 三类不可；二类需持证技师（`technician_certs` 中级及以上） |
| L4 | 一类 | 二类/三类不可；一类需高级技师+设备（可首期放宽为仅一类） |

**数据来源**：
- `shops.qualification_level`：一类/二类/三类
- `shops.categories`：`["钣金喷漆","发动机维修"]` 等
- `shops.technician_certs`：技师持证 JSON
- 竞价项目：`damage_reports.analysis_result.repair_suggestions` + `repair_complexity_levels` 匹配得复杂度

---

## 四、同项目完单（精确到项目 + 按复杂度分层）

**核心原则**：高复杂度项目才有参考价值，低复杂度项目仅作兜底。

### 匹配逻辑（按复杂度优先）

| 竞价需求 | 匹配策略 | 说明 |
|----------|----------|------|
| 仅补漆(L2) | 任意包含补漆的完单即可 | 补漆复杂度低，有补漆完单即证明能力 |
| 补漆+发动机(L4) | **优先**匹配发动机完单 | 发动机是核心，仅补漆完单参考意义弱 |
| 补漆+发动机(L4) | **兜底**：找不到发动机完单时，再参考补漆 | 实在找不到高复杂度完单，退而求其次 |

**算法**：
1. 解析竞价项目，按 `repair_complexity_levels` 得到每项复杂度（L1–L4）
2. 找出竞价中的**最高复杂度**项目集合（如 L4 的发动机、纵梁等）
3. **优先匹配**：店铺近 90 天完单中，是否有任一项目与「最高复杂度项目」有交集？有 → 通过
4. **兜底匹配**：若无，再检查是否与「次高及以下复杂度项目」有交集？有 → 通过（弱匹配，可影响排序权重）
5. 若竞价仅含单一复杂度（如仅 L2 补漆），则任意同项目完单即可

**数据来源**：
- 竞价：`repair_suggestions` / `damages` + `repair_complexity_levels` 得每项复杂度
- 历史完单：`quotes.items` / `orders.repair_plan`，订单 `status=3`，近 90 天

**同项目完单量分**：优先匹配（高复杂度）的店铺加分更高；兜底匹配的店铺加分较低，可配置两档分值。

---

## 五、推送机制

| 渠道 | 实现方式 |
|------|----------|
| 小程序站内 | `merchant_messages` 表，`type=bidding`，`related_id=bidding_id`，红点由现有 `unread-count` 接口支撑 |
| 公众号 | **预留**：在创建 `merchant_messages` 处预留调用入口，格式待公众号开发时对接 |

**触发时机**：
- 竞价创建时：向第一梯队店铺批量写入 `merchant_messages`
- 第一梯队窗口结束：向第二梯队店铺批量写入
- 一、二梯队不足 3 家时：向第三梯队店铺批量写入（最多 2 家）

**实现方式**（二选一或并用）：
1. **首次请求时**：服务商打开「待报价」列表时，自动补发该店铺应收到的第二、第三梯队消息（已实现）
2. **定时任务**：调用 `POST /api/v1/admin/cron/send-delayed-bidding-messages`，建议每 1–2 分钟执行一次
   - 认证：`X-Cron-Secret` 头与 `.env` 中 `CRON_SECRET` 一致，或使用管理员 Bearer Token
   - 示例：`curl -X POST https://域名/api/v1/admin/cron/send-delayed-bidding-messages -H "X-Cron-Secret: 你的密钥"`

---

## 六、其他说明

### 1. 产能（满负荷预警）

首期 `filterCapacityCheck = false`，不校验；后续扩展时由运营录入或对接产能系统。

### 2. 场景权重系数

**文档**：服务商综合匹配分 = 店铺综合得分 × 场景权重系数 + 同项目完单量分 + 报价历史准确度分 + 时效履约率分。

**现状**：`shop-sort-service` 有 `SCENE_WEIGHTS`，但竞价场景未明确。

**建议**：竞价场景按订单复杂度（L1–L2 / L3–L4）使用不同权重，与《06-店铺列表排序算法》一致。权重系数可配置，默认：
- L1–L2：店铺 0.35
- L3–L4：店铺 0.60

### 3. 同项目完单量分、报价历史准确度分、时效履约率分

- **同项目完单量分**：近 90 天同项目订单完成数，按档位加分；**优先匹配**（高复杂度项目）的完单加分更高，**兜底匹配**（低复杂度）的完单加分较低，可配置两档分值。
- **报价历史准确度分**：用 `shops.deviation_rate`，≤10% 满分、>30% 0 分，线性插值。
- **时效履约率分**：若有订单工期字段可计算；暂无则首期用默认 50 分。

---

## 七、实施步骤

### 阶段 1：配置与数据层

1. 新增 `biddingDistribution` JSON 配置到 `settings` 表，写入默认值。
2. 管理后台：在现有「系统配置」页增加「竞价分发」区块，支持上述字段编辑。
3. 后端：`getBiddingDistributionConfig(pool)` 读取配置，缺省用默认值。

### 阶段 2：资质与能力过滤

1. **资质**：实现 `checkShopQualificationForBidding(pool, shopId, biddingId)`：
   - 从竞价定损解析复杂度（L1–L4）及项目列表
   - 按《修理厂资质等级和维修复杂度之间的关系》校验 `qualification_level`、`categories`、`technician_certs`
2. **能力（同项目完单）**：实现 `hasSameProjectCompletion(pool, shopId, biddingId)`：
   - 解析竞价项目及每项复杂度（repair_complexity_levels）
   - 优先匹配最高复杂度项目；若无，兜底匹配次高及以下
   - 新店豁免

### 阶段 3：硬门槛过滤与兜底

1. 实现 `filterShopsForBidding(pool, biddingId, userId)`：
   - 距离 ✓（已有）
   - 资质 ✓（阶段 2）
   - 合规：`compliance_rate >= config.filterComplianceMin`，新店视为 100%
   - 违规：`violation_records` 近 N 天无 `violation_level = 4`
   - 能力 ✓（阶段 2）
   - 产能：首期跳过
2. 兜底：过滤后不足 3 家时，按 20% 扩大 `range_km` 直至凑够 N 家。

### 阶段 4：综合匹配分与梯队

1. 实现 `calcMerchantMatchScore(pool, shop, bidding, opts)`：
   - 店铺综合得分（含新店基础分）
   - × 场景权重系数
   - + 同项目完单量分（精确到项目）
   - + 报价历史准确度分（deviation_rate）
   - + 时效履约率分（默认 50）
2. 按配置划分梯队：第一 / 第二 / 第三梯队。
3. 竞价表增加 `tier1_window_ends_at`（创建时 + 15 分钟），用于窗口期判断。
4. 修改 `listBiddingsForShop`：在可见性条件中增加梯队过滤。
5. 分发数量上限：L1–L2 最多 10 家 / 有效 5 家停止；L3–L4 最多 15 家 / 有效 8 家停止。

### 阶段 5：推送与消息

1. 竞价创建时：计算第一梯队店铺，批量写入 `merchant_messages`（type=bidding）。
2. 第一梯队窗口结束：向第二梯队店铺批量写入（可定时任务或首次请求时触发）。
3. 一、二梯队不足 3 家时：向第三梯队店铺批量写入（最多 2 家）。
4. 预留公众号推送接口（空实现或占位）。

### 阶段 6：报价排序（已有）

- 报价排序公式已实现，将 `calcMatchScore` 升级为 `calcMerchantMatchScore`，保证与梯队划分一致。

---

## 八、文档同步

- 实现完成后同步更新 `docs/体系/07-竞价单分发机制.md`，补充参数说明与实现细节。
