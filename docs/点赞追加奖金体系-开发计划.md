# 点赞追加奖金体系 - 开发计划

> **【已归档，不再使用】** 开发任务参考，规则以 [docs/体系/04-点赞追加奖金体系.md](./体系/04-点赞追加奖金体系.md) 为准。

---

> 基于《点赞追加奖金体系完整标准方案-V1.0正式版.md》，结合当前项目现状制定。**已确认事项见第三节**。

---

## 一、当前项目现状

### 1.1 已有能力

| 模块 | 现状 | 说明 |
|------|------|------|
| 评价体系 | ✅ 已实现 | reviews 表、主评价/追评、AI 审核、reward_amount |
| 基础奖励金 | ✅ 已实现 | reward-calculator.js，按复杂度/车价/订单分级计算 |
| 用户等级 0-4 级 | ✅ 已实现 | users.level、user_verification、user_vehicles |
| 佣金 | ✅ 已实现 | orders.commission、commission_rate，完成时写入 |
| 评价展示 | ✅ 已实现 | 维修厂详情页评价列表，like_count 字段存在 |
| 交易记录 | ✅ 已实现 | transactions 表，type: rebate/withdraw/recharge |

### 1.2 缺失能力

| 模块 | 缺失 | 影响 |
|------|------|------|
| 点赞记录 | ❌ 无 review_likes 表 | 无法记录谁点赞、何时、是否有效、是否事后验证 |
| 浏览/阅读记录 | ❌ 无 | 无法校验「看到了」「有效阅读时长」、事后验证「下单前 7 天有浏览」 |
| 点赞接口 | ❌ 无 | 用户无法对评价点赞 |
| 点赞追加奖金核算 | ❌ 无 | 常规点赞追加、内容转化、事后验证补发均未实现 |
| 评价内容质量等级 | ❌ 无 | 1-4 级（基础/优质/标杆/爆款）未判定 |
| 列表内展开 + 视口/停留上报 | ❌ 无 | 评价列表需支持展开，并上报「看到了」「有效阅读时长」 |

---

## 二、核心业务规则：「看到了」与「有效阅读时长」

> 不判断用户「逐字逐句读了多久」，只判断「是否真的注意到了这条评论、是否花了足够时间获取信息」。

| 概念 | 判定标准 |
|------|----------|
| **「看到了」** | 评论内容的 **≥50% 区域进入用户手机视口**，且停留≥1 秒；快速划过只露标题的不算 |
| **有效阅读时长** | 在「看到了」的基础上，用户停留在这条评论的时间（**排除切后台、无操作、划走的时间**）≥30 秒，才可触发有效点赞、决策权重核算 |
| **防刷兜底** | 单条评论单次有效阅读时长最多算 3 分钟；总有效阅读时长最多算 5 分钟，超过部分不计入 |

---

## 三、开发范围（按落地优先级三阶段）

### 第一阶段：常规点赞追加 + 事后验证前台展示（1-2 天）

| 序号 | 任务 | 类型 | 说明 |
|------|------|------|------|
| 1 | 数据库：review_likes 表 | 新增 | 记录 user_id、review_id、有效阅读时长、点赞时间、is_post_verify、权重系数等 |
| 2 | 数据库：review_reading_sessions 表 | 新增 | 记录每次「看到了」后的有效阅读会话（单次最多 3 分钟），用于累计有效阅读时长 |
| 3 | 接口：POST /api/v1/reviews/:id/reading | 新增 | 上报「看到了」+ 有效阅读时长；前端在列表展开时，根据视口交叉、停留、切后台等计算并上报 |
| 4 | 接口：POST /api/v1/reviews/:id/like | 新增 | 点赞，可直接点；后台校验有效阅读时长≥30 秒、账号权重＞0、单用户单评价终身 1 次；不满足则前台展示点赞、不纳入奖金 |
| 5 | 接口：GET 评价列表扩展 | 修改 | 返回 like_count、post_verify_count、「车主验证・真实避坑」标签 |
| 6 | 前端：评价列表项可展开 | 新增 | 列表内展开，展开后开始视口与停留监测 |
| 7 | 前端：视口 + 停留 + 有效阅读时长计算 | 新增 | ≥50% 进入视口且≥1 秒=「看到了」；累计有效阅读（排除切后台/划走），单次≤3 分钟、总≤5 分钟 |
| 8 | 前端：点赞按钮 | 新增 | 评价在哪里，点赞就在哪里；可直接点，后台决定是否纳入奖金 |
| 9 | ~~月度核算任务（常规点赞追加）~~ | ~~新增~~ | **已取消**；点赞追加奖金发放方式待定（可考虑实时发放或延后实现） |

### 第二阶段：内容转化追加 + 事后验证补发 + 实时反馈（约 1 周）

| 序号 | 任务 | 类型 | 说明 |
|------|------|------|------|
| 10 | 订单完成时：内容转化奖金池分配 | 新增 | 用户确认完工后，查找 7 天内点赞过该用户决策相关评价的发布者，按决策权重分配 |
| 11 | 事后验证补发逻辑 | 新增 | 用户修车后回头点赞，满足 5 项判定时，从该笔成交奖金池划出 50% 补发 |
| 12 | 接口：GET 奖励金明细扩展 | 修改 | 区分基础/追评/常规点赞追加/内容转化/事后验证补发 |
| 13 | 前端：发布评价后实时显示预计追加奖金 | 修改 | 评价审核通过后展示「预计累计可获点赞追加」 |

### 第三阶段：四维反作弊 + 内容转化效率分 + 创作者成长（约 2 周）

| 序号 | 任务 | 类型 | 说明 |
|------|------|------|------|
| 14 | 四维一体反作弊 | 新增 | 设备/账号/行为/交易风控，事前拦截 |
| 15 | 内容转化效率分 | 新增 | 用于评价排序补充权重 |
| 16 | 创作者成长扶持 | 新增 | 认证车主创作者、成长分加成等 |

---

## 四、已确认事项

### 4.1 数据与结构

| 编号 | 确认结论 |
|------|----------|
| **Q1 车型匹配** | **仅通过车牌号匹配**；点赞者车辆（user_vehicles 或最近订单 vehicle_info 的 plate_number）与评价对应订单车辆（biddings.vehicle_info 的 plate_number）一致即匹配，否则不匹配 |
| **Q2 评价与订单** | 追评和主评价共用同一订单佣金，只是比例不同；点赞追加按该订单 commission 算 |
| **Q3 佣金红线** | **以 80% 为准**；常规总奖金（基础+追评+常规点赞追加）≤ 实收佣金 80% |

### 4.2 交互与流程

| 编号 | 确认结论 |
|------|----------|
| **Q4 评价展示** | **列表内展开**；无独立详情页，在列表项内展开 |
| **Q5 点赞前置** | **不需要**；用户可以直接点赞，无需先等 30 秒 |
| **Q6 阅读判定** | 见第二节「看到了」与「有效阅读时长」；不按「逐字逐句读了多久」，按视口+停留+有效阅读时长 |

### 4.3 业务规则

| 编号 | 确认结论 |
|------|----------|
| **Q7 内容质量等级** | 按实际情况安排；1-4 级实现节奏由开发阶段决定 |
| **Q8 用户等级核算** | 待定；点赞时先用当前 level 映射权重 |
| **Q9 成交定义** | **是**；仅平台撮合订单（status=3 已完成），自费/保险均算 |

### 4.4 实施范围

| 编号 | 确认结论 |
|------|----------|
| **Q10 奖金发放** | 基础/追评等分类汇总后统一发放；**常规点赞追加月度核算已取消**，发放方式待定（可考虑实时发放或延后实现） |
| **Q11 点赞入口** | **点赞跟随评价**；评价在哪里展示，点赞就在哪里，不限于维修厂详情页 |

---

## 五、数据库变更清单（草案）

### 5.1 新增表

**review_likes**（点赞记录）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT PK | |
| like_id | VARCHAR(32) UNIQUE | 业务主键 |
| review_id | VARCHAR(32) | 评价 ID |
| user_id | VARCHAR(32) | 点赞用户 |
| effective_reading_seconds | INT | 点赞时累计的有效阅读时长（秒） |
| like_type | VARCHAR(20) | normal / post_verify |
| is_valid_for_bonus | TINYINT | 是否纳入奖金核算（有效阅读≥30 秒且账号权重＞0） |
| weight_coefficient | DECIMAL(6,4) | 账号综合权重系数 |
| vehicle_match_by_plate | TINYINT | 车型匹配：1=车牌一致 0=否 |
| created_at | DATETIME | 点赞时间 |

**review_reading_sessions**（有效阅读会话，用于累计有效阅读时长）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT PK | |
| session_id | VARCHAR(32) UNIQUE | 业务主键 |
| review_id | VARCHAR(32) | 评价 ID |
| user_id | VARCHAR(32) | 浏览用户 |
| effective_seconds | INT | 本次有效阅读秒数（单次最多 180） |
| saw_at | DATETIME | 「看到了」的时刻（≥50% 入视口且≥1 秒） |
| ended_at | DATETIME | 会话结束（划走/切后台/超 3 分钟） |
| created_at | DATETIME | |

注：同一用户对同一评价的 total effective_seconds 累计上限 300 秒（5 分钟），超出不计入。

### 5.2 扩展表

**reviews**：新增 `content_quality_level`（1-4）、`post_verify_like_count`（事后验证点赞数，冗余便于展示）

**transactions**：type 扩展 `like_bonus`、`conversion_bonus`、`post_verify_bonus`

---

## 六、下一步

1. 按第一阶段任务清单开始实现。
2. 用户等级核算（Q8）待定，暂用当前 level 映射权重。
