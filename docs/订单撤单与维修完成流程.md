# 订单撤单与维修完成流程

版本：v1.0  
日期：2026-02  
适用范围：车主端、服务商端、后台运维

---

## 1. 概述

本文档描述订单撤销逻辑、维修完成凭证、以及撤单申请（超过 30 分钟需服务商同意或人工处理）的完整流程。

**基本原则**：仅车主可发起撤单，服务商不允许撤单。

---

## 2. 订单撤销逻辑

### 2.1 撤销规则

| 场景 | 条件 | 处理方式 |
|------|------|----------|
| A | 服务商未接单 (status=0) | 车主可随时撤销，直接生效 |
| B | 服务商已接单，接单 ≤ 30 分钟 | 车主可随时撤销，直接生效 |
| C | 服务商已接单，接单 > 30 分钟 | 需走撤单申请流程：填写理由 → 服务商同意/拒绝 |
| D | 订单已完成 (status=3) | 不可撤销 |

**接单时间**：`orders.accepted_at`，服务商接单时写入。

### 2.2 撤单申请流程（场景 C）

1. **车主发起**：填写撤单理由，提交申请 → 插入 `order_cancel_requests`（status=0 待服务商处理）
2. **服务商响应**：
   - **同意**：订单 status→4，竞价重开，通知车主
   - **拒绝**：订单保持原状态，**通知车主**；车主可选择**继续交易**或**提交人工通道**
3. **车主提交人工通道**：服务商拒绝后，车主可选择继续交易或提交人工；若提交人工，更新申请 status→3（已提交人工），通知后台人员处理
4. **后台处理**：由后台人员决定是否取消订单；同意则更新申请 status→4、订单 status→4、竞价重开；拒绝则 status→5

### 2.3 数据变更

| 步骤 | 触发 | 数据变更 |
|------|------|----------|
| 直接撤销（A/B） | 车主撤销 | UPDATE orders SET status=4；UPDATE biddings SET status=0, selected_shop_id=NULL |
| 撤单申请 | 车主提交 | INSERT order_cancel_requests (status=0) |
| 服务商同意 | 服务商操作 | UPDATE order_cancel_requests SET status=1；同直接撤销 |
| 服务商拒绝 | 服务商操作 | UPDATE order_cancel_requests SET status=2, shop_response_at=NOW() |
| 提交人工 | 车主操作 | UPDATE order_cancel_requests SET status=3, escalated_at=NOW() |
| 人工同意 | 后台操作 | UPDATE order_cancel_requests SET status=4；同直接撤销 |
| 人工拒绝 | 后台操作 | UPDATE order_cancel_requests SET status=5 |

---

## 3. 维修完成凭证

### 3.1 触发时机

服务商点击「维修完成」、将订单状态从 1（维修中）更新为 2（待确认）时，**必须**同步上传维修完成凭证。

### 3.2 凭证类型与要求

| 类型 | 说明 | 要求 |
|------|------|------|
| 修复后照片 | 维修完成后的实拍图 | 至少 1 张 |
| 定损单/结算单 | 保险有定损单，否则为结算单 | 至少 1 张 |
| 物料照片 | 配件、材料等 | 至少 1 张 |

每种类型至少 1 张，无最小数量上限要求。

### 3.3 存储

存入 `orders.completion_evidence`（JSON）：

```json
{
  "repair_photos": ["url1", "url2"],
  "settlement_photos": ["url1"],
  "material_photos": ["url1"]
}
```

### 3.4 与评价的关联

- **定损单/结算单**：用于比较实际项目与预估报价的差别，计算报价准确性
- **修复后照片**：对应评价模块 3 的「完工实拍图」
- **物料照片**：对应评价模块 2 的「维修过程」材料

车主评价时，上述凭证**自动预填**到对应评价项，**不可删除**，需明确标注来源（服务商上传/车主上传）；车主可**新增**照片，新增部分标注「车主上传」。

**照片对应关系**：

| 服务商凭证 | 评价对应 | 用途 |
|-----------|----------|------|
| 定损单/结算单 | 报价准确性 | 比较实际项目与预估报价的差别，计算报价准确性（保险才有定损单，否则用结算单） |
| 修复后照片 | 完工实拍图 | 模块 3 完工验收 |
| 物料照片 | 维修过程材料 | 模块 2 维修过程 |

---

## 4. 依赖接口（待实现）

| 接口 | 方法 | 说明 |
|------|------|------|
| /api/v1/user/orders/:id/cancel | POST | 撤销订单（直接撤销或创建撤单申请） |
| /api/v1/merchant/orders/:id/cancel-request/:requestId/respond | POST | 服务商响应撤单申请（同意/拒绝） |
| /api/v1/user/orders/:id/cancel-request/:requestId/escalate | POST | 车主提交人工通道 |
| /api/v1/merchant/orders/:id/status | PUT | 更新状态（维修完成时需传 completion_evidence） |
| /api/v1/admin/order-cancel-requests/:id/resolve | POST | 后台人工处理撤单申请 |

---

## 5. 修订记录

| 版本 | 日期 | 说明 |
|------|------|------|
| v1.0 | 2026-02 | 初稿：撤单规则、维修凭证、与评价关联 |
