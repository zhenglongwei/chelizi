# 奖励金审计日志与算法测试

> 用于检查评价内容等级、奖励金、追加奖金相关算法与逻辑是否正确。

---

## 一、审计日志

### 1.1 启用方式

环境变量 `REWARD_AUDIT_LOG=1` 或 `REWARD_AUDIT_LOG=true` 时，在以下关键环节输出结构化 JSON 日志：

| 环节 | event | 主要参数 |
|------|-------|----------|
| 评价提交 | `review_submit` | reward_pre、content_quality_level、total_reward、user_receives、l1_monthly_cap 等 |
| 点赞 | `like` | total_reading_seconds、credibility_weight、weight_coefficient、like_type 等 |
| 常规点赞追加 | `like_bonus` | commission、cap80、weight_sum、bonus_after_tax 等 |
| 内容转化追加 | `conversion_bonus` | decision_weight、weight_breakdown、share_after_tax 等 |
| 事后验证补发 | `post_verify_bonus` | commission、bonus_after_tax 等 |
| 评价升级差额 | `upgrade_diff` | diff_amount、calc_reason 等 |

### 1.2 日志格式

每行以 `[REWARD-AUDIT]` 开头，后接 JSON：

```
[REWARD-AUDIT] {"ts":"2026-02-27T10:00:00.000Z","event":"review_submit","review_id":"REV123",...}
```

### 1.3 查看方式

```bash
# 启动时启用
REWARD_AUDIT_LOG=1 node web/api-server/server.js

# 从日志文件中筛选
grep "\[REWARD-AUDIT\]" /var/log/chelizi.log
```

---

## 二、算法自动化测试

### 2.1 运行

```bash
node web/scripts/test-reward-algorithms.js
```

### 2.2 覆盖范围

| 模块 | 测试项 |
|------|--------|
| reward-calculator | getVehicleCoeff、getOrderTier、calcPremiumFloatReward、getComplexityCoeff、ORDER_TIER_CAP |
| conversion-bonus | getDecisionTimeWeight、getContentStayWeight、getContentMatchWeight、getContentValueWeight、calcDecisionWeight |
| review-like | 可信度权重、车型匹配、账号综合权重系数 |

### 2.3 扩展

在 `web/scripts/test-reward-algorithms.js` 中按需增加用例，使用 `assert.strictEqual` 校验预期值。
