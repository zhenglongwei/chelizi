# 内容转化追加 + 事后验证补发 - 实施规划

> **定位**：项目吸引用户的关键激励模块，锚定「评价对车主真实决策价值」，实现「内容价值越高、收益越高、上不封顶」。规则以《04-点赞追加奖金体系》为准。

---

## 一、业务价值与优先级

| 模块 | 用户价值 | 对平台的价值 | 建议优先级 |
|------|----------|--------------|------------|
| **内容转化追加** | 评价被点赞后若促成成交，发布者获得转化奖金 | 激励高价值内容、强化「看了有用」心智 | P0 |
| **事后验证补发** | 修车后回头点赞，获得专属补发 | 强化「真实避坑」标签、提升内容可信度 | P1 |

---

## 二、内容转化追加 - 实施规划

### 2.1 核心逻辑

```
单条评价可获得的单笔成交转化奖金 = 内容转化奖金池 ×（该评价决策权重 ÷ 本次成交所有有效评价决策权重总和）
```

- **内容转化奖金池** = 该笔订单实收佣金 × 50%
- **准入**：有效评价 + 7 天窗口内有效点赞 + 车型/项目匹配 + 单笔最多 10 条分配

### 2.2 决策权重（四维相乘）

| 维度 | 权重占比 | 系数表 | 数据来源 |
|------|----------|--------|----------|
| 决策时间 | 40% | 24h 内 4.0；24–72h 2.0；3–7 天 1.0 | `review_likes.created_at` vs `orders.created_at` |
| 内容停留 | 30% | ≥3 分钟 3.0；1–3 分钟 2.0；30 秒–1 分钟 1.0 | `review_reading_sessions` 汇总 |
| 内容匹配 | 20% | 同车型+同项目 3.0；同车型+同类 2.0；同价位+同类 1.0 | `biddings.vehicle_info`、`quotes.items` vs `reviews` 对应订单 |
| 内容价值 | 10% | 4 级 3.0；3 级 2.0；2 级 1.0；1 级 0.5 | `reviews.content_quality_level` |

### 2.3 触发时机

- **订单完成时**（`orders.status = 3` 且 `completed_at` 写入）
- 回溯：该订单的 `user_id`（买家）在订单创建前 7 天内点赞过的评价
- 条件：点赞者 = 订单用户；点赞时间在 `orders.created_at` 前 7 天内

### 2.4 数据流与依赖

```
orders (user_id, created_at, order_id)
  → review_likes (user_id = 订单用户, created_at 在订单前 7 天内)
  → reviews (review_id, order_id, content_quality_level, vehicle_model_key, repair_project_key)
  → review_reading_sessions (review_id, user_id, effective_seconds, saw_at)
  → biddings.vehicle_info、quotes.items（车型、项目匹配）
```

### 2.5 实施阶段

| 阶段 | 任务 | 预估 |
|------|------|------|
| **阶段 1** | 决策时间权重：点赞时间 vs 订单创建时间 | 0.5 天 |
| **阶段 2** | 内容停留权重：review_reading_sessions 按 review_id+user_id 汇总 | 0.5 天 |
| **阶段 3** | 内容匹配权重：车型/项目匹配（简化：车牌一致 3.0，同品牌同系 2.0，其他 1.0） | 1 天 |
| **阶段 4** | 内容价值权重：content_quality_level 映射 | 0.5 天 |
| **阶段 5** | 订单完成时触发、按权重分配、写入 reward_settlement_pending（type=conversion） | 1 天 |
| **阶段 6** | 接入月度结算任务 | 0.5 天 |

**合计**：约 4 天

### 2.6 数据库变更

- `reward_settlement_pending.pending_type` 扩展：`conversion_bonus`
- `transactions.type` 扩展：`conversion_bonus`（已有）

### 2.7 风险与简化

| 风险 | 缓解 |
|------|------|
| 内容匹配逻辑复杂 | 首版简化为：车牌一致 3.0、同品牌 2.0、其他 1.0 |
| 订单完成时机不确定 | 在订单 status 更新为 3 时异步触发，或由月度结算任务回溯上月完成订单 |

---

## 三、事后验证补发 - 实施规划

### 3.1 判定条件（5 项全满足）

| 序号 | 条件 | 数据来源 |
|------|------|----------|
| 1 | 下单前 7 天有浏览 | `review_reading_sessions`：user_id=订单用户，saw_at < orders.created_at 且在 7 天内 |
| 2 | 同品牌同车系同类项目真实交易 | 订单的 vehicle_info、quote items 与评价对应订单匹配 |
| 3 | 完工后 30 天内点赞 | `review_likes.created_at` 在 `orders.completed_at` 后 30 天内 |
| 4 | 有效点赞标准 | `review_likes.is_valid_for_bonus = 1` |
| 5 | 单笔交易最多 1 条触发 | 该订单未给其他评价分配过事后验证补发 |

### 3.2 补发规则

- 常规点赞：已纳入常规点赞追加核算
- 专属补发：该笔成交**未**给其他评价分配过内容转化时，从奖金池划出 50% 补发
- 奖金池 = 订单实收佣金 × 50%（与内容转化共用池，互斥分配）

### 3.3 触发时机

- **月度结算时**：遍历上月完成的订单，对每个订单检查是否存在满足 5 项的事后验证点赞
- 或：**点赞时**标记 `like_type = 'post_verify'`，月度结算时读取

### 3.4 数据流

```
orders (user_id, created_at, completed_at, order_id, bidding_id)
  → biddings.vehicle_info
  → review_reading_sessions (user_id=订单用户, review_id, saw_at 在订单前 7 天)
  → review_likes (user_id=订单用户, review_id, created_at 在 completed_at 后 30 天内, like_type=post_verify)
  → reviews (评价对应订单的 vehicle、project 与当前订单匹配)
```

### 3.5 实施阶段

| 阶段 | 任务 | 预估 |
|------|------|------|
| **阶段 1** | 点赞时判定：是否满足「下单前 7 天浏览 + 完工后 30 天内」→ 写入 `like_type=post_verify` | 1 天 |
| **阶段 2** | 车型/项目匹配校验（同品牌同车系同类项目） | 1 天 |
| **阶段 3** | 月度结算：读取 post_verify 点赞，校验单笔最多 1 条、与内容转化互斥 | 1 天 |
| **阶段 4** | 前台：post_verify_like_count、红标、「XX 位车主验证有用」 | 0.5 天 |

**合计**：约 3.5 天

### 3.6 与内容转化的互斥

- 同一笔订单的奖金池（佣金 50%）：若已分配内容转化，则事后验证不补发；若未分配，则事后验证可补发 50%
- 实现：结算时先处理内容转化，再处理事后验证；事后验证仅当该订单无内容转化分配时执行

---

## 四、实施顺序建议

| 顺序 | 模块 | 理由 |
|------|------|------|
| 1 | 内容转化追加 | 触发更频繁（每笔成交），用户感知更强 |
| 2 | 事后验证补发 | 依赖内容转化的互斥逻辑，且需点赞时标记 post_verify |

---

## 五、前置检查清单

- [ ] `review_reading_sessions` 有 `saw_at`，且前端正确上报
- [ ] `review_likes` 有 `like_type`、`is_valid_for_bonus`
- [ ] `reviews` 有 `content_quality_level`、`vehicle_model_key`、`repair_project_key`
- [ ] `orders` 有 `created_at`、`completed_at`
- [ ] `biddings` 有 `vehicle_info`
- [ ] 月度结算任务已支持 `conversion_bonus`、`post_verify_bonus` 类型

---

## 六、文档同步

- 实现后需同步更新：`docs/体系/04-点赞追加奖金体系.md`（实施说明）、`docs/评价与点赞奖励-定期结算方案.md`（结算范围）
