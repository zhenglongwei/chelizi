# 车厘子 - 数据库设计文档

版本：v1.0  
日期：2026-02-11  
基于：MySQL 8.0 / 阿里云 RDS

---

## 1. 概述

### 1.1 设计目标

为事故车维修平台（车厘子）提供完整的数据存储方案，支撑 AI 定损、竞价报价、订单、评价、奖励金等核心业务。评价与激励体系、核心算法以《全指标底层逻辑梳理.md》为准。

### 1.2 技术选型

| 项目 | 说明 |
|------|------|
| 数据库 | MySQL 8.0 |
| 字符集 | utf8mb4 / utf8mb4_unicode_ci |
| 存储引擎 | InnoDB |
| 部署 | 阿里云 ECS/RDS |
| Schema 文件 | `web/database/schema.sql` |

### 1.3 设计原则

- 以需求文档第 6 章数据模型为基础，不做兼容旧结构
- 业务主键使用 `{实体}_id`（如 user_id、order_id），便于跨系统、迁移
- 金额、比例统一使用 DECIMAL，避免浮点误差
- 状态字段使用 TINYINT，在文档中明确定义枚举值

---

## 2. 表结构总览

| 序号 | 表名 | 说明 |
|------|------|------|
| 1 | users | 用户表（车主） |
| 2 | shops | 维修厂表 |
| 3 | damage_reports | 定损报告表 |
| 4 | biddings | 竞价表 |
| 5 | quotes | 报价表 |
| 6 | orders | 订单表 |
| 7 | reviews | 评价表 |
| 8 | transactions | 交易/余额变动记录表 |
| 9 | withdrawals | 提现申请表 |
| 10 | user_messages | 用户消息表 |
| 11 | user_favorite_shops | 用户收藏维修厂表 |
| 12 | merchant_users | 服务商账号表 |
| 13 | shop_penalties | 维修厂惩罚记录表 |
| 14 | settings | 系统配置表 |
| 15 | repair_complexity_levels | 维修项目复杂度等级（L1-L4）【评价体系新增】 |
| 16 | reward_rules | 奖励金规则配置【评价体系新增】 |
| 17 | review_dimensions | 评价维度记录（报价/过程/完工；追评单独）【评价体系新增】 |
| 18 | review_audit_logs | 评价审核与人工复核留痕【评价体系新增】 |
| 19 | complexity_upgrade_requests | 用户破格升级申请【评价体系新增】 |
| 20 | order_cancel_requests | 订单撤单申请（超30分钟需服务商同意或人工处理）【撤单流程新增】 |
| 21 | user_verification | 用户实名认证【用户等级体系】 |
| 22 | user_vehicles | 用户绑定车辆【用户等级体系】 |
| 23 | withheld_rewards | 待回溯奖励（0级因未实名/车辆暂扣，认证后补发）【用户等级体系】 |
| 24 | review_reading_sessions | 评价有效阅读会话（点赞追加奖金体系） |
| 25 | review_likes | 评价点赞记录（点赞追加奖金体系） |
| 26 | reward_settlement_pending | 待结算奖励（评价升级差额等，月度结算） |
| 27 | reward_settlement_logs | 月度结算任务日志 |
| 28 | post_verify_settled_orders | 已发放事后验证补发的订单（防重复发放） |

---

## 3. ER 关系图（概要）

```
users ──┬── damage_reports
        ├── biddings ──── quotes (shop_id → shops)
        │       │
        │       └── orders ───┬── order_cancel_requests
        │                     ├── reviews ──── review_dimensions
        │                     │                   review_audit_logs
        │                     │                   review_reading_sessions
        │                     │                   review_likes
        │                     └── complexity_upgrade_requests (order_id)
        ├── transactions
        ├── withdrawals
        ├── user_messages
        ├── user_favorite_shops ──── shops
        ├── user_verification
        ├── user_vehicles
        └── withheld_rewards

shops ──┬── merchant_users
        ├── quotes
        ├── orders
        ├── reviews
        └── shop_penalties

repair_complexity_levels、reward_rules 为配置/映射表
```

---

## 4. 表结构详细说明

### 4.1 users（用户表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGINT UNSIGNED | PK, AUTO_INCREMENT | 自增主键 |
| user_id | VARCHAR(32) | UNIQUE, NOT NULL | 业务主键 |
| openid | VARCHAR(64) | UNIQUE, NOT NULL | 微信 openid |
| unionid | VARCHAR(64) | | 微信 unionid |
| nickname | VARCHAR(100) | | 昵称 |
| avatar_url | VARCHAR(500) | | 头像 URL |
| phone | VARCHAR(20) | | 手机号 |
| level | TINYINT UNSIGNED | DEFAULT 0 | 用户可信度等级 0–4（用户等级体系） |
| level_demoted_by_violation | TINYINT UNSIGNED | DEFAULT 0 | 是否曾因违规降级，恢复1级时不可回溯奖励 |
| level_updated_at | DATETIME | | 等级最后核算时间 |
| points | INT UNSIGNED | DEFAULT 0 | 积分 |
| balance | DECIMAL(10,2) | DEFAULT 0 | 奖励金余额（原返点余额） |
| total_rebate | DECIMAL(10,2) | DEFAULT 0 | 累计奖励金（原累计返点） |
| total_reviews | INT UNSIGNED | DEFAULT 0 | 评价总数 |
| province | VARCHAR(50) | | 省份 |
| city | VARCHAR(50) | | 城市 |
| district | VARCHAR(50) | | 区县 |
| latitude | DECIMAL(10,8) | | 纬度 |
| longitude | DECIMAL(11,8) | | 经度 |
| status | TINYINT UNSIGNED | DEFAULT 1 | 0-禁用 1-启用 |
| created_at | DATETIME | | 创建时间 |
| updated_at | DATETIME | | 更新时间 |

**索引**：openid, user_id

---

### 4.2 shops（维修厂表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGINT UNSIGNED | PK, AUTO_INCREMENT | 自增主键 |
| shop_id | VARCHAR(32) | UNIQUE, NOT NULL | 业务主键 |
| name | VARCHAR(100) | NOT NULL | 维修厂名称 |
| logo | VARCHAR(500) | | Logo URL |
| shop_images | JSON | | 服务商/店铺环境照片 URL 数组 |
| address | VARCHAR(255) | NOT NULL | 详细地址 |
| province | VARCHAR(50) | NOT NULL | 省份 |
| city | VARCHAR(50) | NOT NULL | 城市 |
| district | VARCHAR(50) | NOT NULL | 区县 |
| latitude | DECIMAL(10,8) | NOT NULL | 纬度 |
| longitude | DECIMAL(11,8) | NOT NULL | 经度 |
| phone | VARCHAR(20) | NOT NULL | 联系电话 |
| business_hours | VARCHAR(100) | | 营业时间 |
| categories | JSON | | 服务分类 ["钣金喷漆", ...] |
| rating | DECIMAL(2,1) | DEFAULT 5.0 | 综合评分 0–5 |
| rating_count | INT UNSIGNED | DEFAULT 0 | 评价数量 |
| deviation_rate | DECIMAL(5,2) | DEFAULT 0 | 平均报价偏差率(%) |
| total_orders | INT UNSIGNED | DEFAULT 0 | 总订单数 |
| is_certified | TINYINT UNSIGNED | DEFAULT 0 | 0-否 1-是 |
| compliance_rate | DECIMAL(5,2) | | AI 校验维修合规率(%)【评价体系新增】 |
| complaint_rate | DECIMAL(5,2) | | 用户有效投诉率(%)【评价体系新增】 |
| qualification_level | VARCHAR(20) | | 维修资质等级【评价体系新增】 |
| qualification_ai_recognized | VARCHAR(20) | | AI 识别的资质等级，null 表示未识别 |
| qualification_ai_result | VARCHAR(32) | | AI 识别结果：recognized/recognition_failed/no_qualification_found |
| technician_certs | JSON | | 技师持证 [{avatar_url,name,level,years,certificate_url,ai_recognized_level,...}]；用户修改等级则需人工审核 |
| qualification_status | TINYINT UNSIGNED | DEFAULT 0 | 资质审核状态 0-待审核 1-通过 2-驳回待修改【方案A】 |
| qualification_audit_reason | VARCHAR(500) | | 待审核/驳回原因 |
| qualification_withdrawn | TINYINT UNSIGNED | DEFAULT 0 | 资质是否已撤回：0=否 1=是（审核中时可撤回后重新编辑） |
| certifications | JSON | | 资质 [{type,name,image}]；含 license(营业执照)、qualification_cert(维修资质证明) |
| services | JSON | | 服务项目 [{name,min_price,max_price}] |
| status | TINYINT UNSIGNED | DEFAULT 1 | 0-禁用 1-启用 |
| created_at | DATETIME | | 创建时间 |
| updated_at | DATETIME | | 更新时间 |

**索引**：shop_id, (latitude,longitude), rating

---

### 4.3 damage_reports（定损报告表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGINT UNSIGNED | PK, AUTO_INCREMENT | 自增主键 |
| report_id | VARCHAR(32) | UNIQUE, NOT NULL | 业务主键 |
| user_id | VARCHAR(32) | NOT NULL, FK→users | 用户 ID |
| vehicle_info | JSON | NOT NULL | {plate_number, model, mileage} |
| images | JSON | NOT NULL | 事故照片 URL 数组 |
| analysis_result | JSON | | AI 分析结果：damages、repair_suggestions、total_estimate、raw_ai_response（完整原始返回，含 vehicles、accidentInfo、photoDetails、unattributedDamage、additionalInfo 等，便于审计与追溯） |
| status | TINYINT UNSIGNED | DEFAULT 0 | 0-分析中 1-已完成 |
| created_at | DATETIME | | 创建时间 |
| updated_at | DATETIME | | 更新时间 |

**索引**：report_id, user_id

---

### 4.4 biddings（竞价表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGINT UNSIGNED | PK, AUTO_INCREMENT | 自增主键 |
| bidding_id | VARCHAR(32) | UNIQUE, NOT NULL | 业务主键 |
| user_id | VARCHAR(32) | NOT NULL, FK→users | 用户 ID |
| report_id | VARCHAR(32) | NOT NULL, FK→damage_reports | 定损报告 ID |
| vehicle_info | JSON | NOT NULL | 车辆信息 |
| insurance_info | JSON | | {is_insurance, company, accident_type} |
| range_km | INT UNSIGNED | DEFAULT 5 | 竞价范围（公里） |
| status | TINYINT UNSIGNED | DEFAULT 0 | 0-进行中 1-已结束 2-已取消 |
| expire_at | DATETIME | NOT NULL | 过期时间 |
| selected_shop_id | VARCHAR(32) | | 选中的维修厂 ID |
| created_at | DATETIME | | 创建时间 |
| updated_at | DATETIME | | 更新时间 |

**status 枚举**：0-进行中、1-已结束、2-已取消

**索引**：bidding_id, user_id, (status, expire_at)

---

### 4.5 quotes（报价表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGINT UNSIGNED | PK, AUTO_INCREMENT | 自增主键 |
| quote_id | VARCHAR(32) | UNIQUE, NOT NULL | 业务主键 |
| bidding_id | VARCHAR(32) | NOT NULL, FK→biddings | 竞价 ID |
| shop_id | VARCHAR(32) | NOT NULL, FK→shops | 维修厂 ID |
| amount | DECIMAL(10,2) | NOT NULL | 报价金额 |
| items | JSON | | 维修项目 [{name, price}] |
| duration | INT UNSIGNED | DEFAULT 3 | 预计工期（天） |
| warranty | INT UNSIGNED | DEFAULT 12 | 质保期限（月） |
| remark | TEXT | | 备注 |
| created_at | DATETIME | | 创建时间 |
| updated_at | DATETIME | | 更新时间 |

**索引**：quote_id, bidding_id, shop_id

---

### 4.6 orders（订单表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGINT UNSIGNED | PK, AUTO_INCREMENT | 自增主键 |
| order_id | VARCHAR(32) | UNIQUE, NOT NULL | 业务主键 |
| bidding_id | VARCHAR(32) | NOT NULL, FK→biddings | 竞价 ID |
| user_id | VARCHAR(32) | NOT NULL, FK→users | 用户 ID |
| shop_id | VARCHAR(32) | NOT NULL, FK→shops | 维修厂 ID |
| quote_id | VARCHAR(32) | NOT NULL, FK→quotes | 报价 ID |
| quoted_amount | DECIMAL(10,2) | NOT NULL | 报价金额 |
| actual_amount | DECIMAL(10,2) | | 实际维修金额 |
| deviation_rate | DECIMAL(5,2) | | 偏差率(%) |
| commission_rate | DECIMAL(4,2) | DEFAULT 12.00 | 佣金比例(%) |
| commission | DECIMAL(10,2) | | 佣金金额 |
| order_tier | TINYINT UNSIGNED | | 订单分级 1-4（一级~四级）【评价体系新增】 |
| complexity_level | VARCHAR(10) | | 维修项目复杂度 L1-L4【评价体系新增】 |
| vehicle_price_tier | VARCHAR(20) | | 车价分级 low/mid/high【评价体系新增】 |
| reward_preview | DECIMAL(10,2) | | 奖励金预估【评价体系新增】 |
| review_stage_status | VARCHAR(50) | | 评价阶段完成状态（主评价/1个月追评/3个月追评）【评价体系新增】 |
| status | TINYINT UNSIGNED | DEFAULT 0 | 订单状态（见下表） |
| accepted_at | DATETIME | | 服务商接单时间（接单时写入，用于撤单 30 分钟判断）【撤单流程新增】 |
| completion_evidence | JSON | | 维修完成凭证（服务商标记完成时必传）【撤单流程新增】结构见下 |
| repair_plan | JSON | | 当前维修方案 {items,value_added_services?,amount?,duration?,warranty?}，接单时从 quote 复制【维修方案流程新增】 |
| repair_plan_status | TINYINT UNSIGNED | DEFAULT 0 | 0=已确认 1=待车主确认【维修方案流程新增】 |
| repair_plan_adjusted_at | DATETIME | | 最近一次维修方案调整时间【维修方案流程新增】 |
| created_at | DATETIME | | 创建时间 |
| updated_at | DATETIME | | 更新时间 |
| completed_at | DATETIME | | 完成时间 |

**completion_evidence 结构**：
```json
{
  "repair_photos": ["url1", "url2"],      // 修复后照片，至少 1 张
  "settlement_photos": ["url1"],          // 定损单或结算单照片（保险有定损单），至少 1 张
  "material_photos": ["url1"]            // 物料照片，至少 1 张
}
```

**status 枚举**：

| 值 | 含义 |
|----|------|
| 0 | 待接单 |
| 1 | 维修中 |
| 2 | 待确认（维修厂完成，等用户确认） |
| 3 | 已完成 |
| 4 | 已取消 |

**索引**：order_id, user_id, shop_id, status

---

### 4.6a order_cancel_requests（订单撤单申请表）【撤单流程新增】

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGINT UNSIGNED | PK, AUTO_INCREMENT | 自增主键 |
| request_id | VARCHAR(32) | UNIQUE, NOT NULL | 业务主键 |
| order_id | VARCHAR(32) | NOT NULL, FK→orders | 订单 ID |
| user_id | VARCHAR(32) | NOT NULL, FK→users | 发起人（车主） |
| reason | VARCHAR(500) | NOT NULL | 撤单理由（超过 30 分钟必填） |
| status | TINYINT UNSIGNED | DEFAULT 0 | 0=待服务商处理 1=服务商同意 2=服务商拒绝 3=已提交人工 4=人工同意 5=人工拒绝 |
| shop_response_at | DATETIME | | 服务商响应时间 |
| escalated_at | DATETIME | | 车主提交人工通道时间 |
| admin_resolution | VARCHAR(20) | | 人工处理：approved/rejected |
| admin_resolved_at | DATETIME | | 人工处理时间 |
| created_at | DATETIME | | 创建时间 |
| updated_at | DATETIME | | 更新时间 |

**status 枚举**：0 待服务商处理、1 服务商同意、2 服务商拒绝、3 已提交人工、4 人工同意、5 人工拒绝

**索引**：request_id, order_id, user_id, status

---

### 4.7 reviews（评价表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGINT UNSIGNED | PK, AUTO_INCREMENT | 自增主键 |
| review_id | VARCHAR(32) | UNIQUE, NOT NULL | 业务主键 |
| order_id | VARCHAR(32) | NOT NULL, FK→orders | 订单 ID |
| shop_id | VARCHAR(32) | NOT NULL, FK→shops | 维修厂 ID |
| user_id | VARCHAR(32) | NOT NULL, FK→users | 用户 ID |
| type | TINYINT UNSIGNED | DEFAULT 1 | 1-主评价 2-追评 3-返厂（返厂等同追评） |
| review_stage | VARCHAR(20) | | main/1m/3m 追评阶段【评价体系新增】 |
| settlement_list_image | VARCHAR(500) | | 维修结算清单图片 URL【评价体系新增】 |
| completion_images | JSON | | 完工实拍图 URL 数组【评价体系新增】；可含 source 标记（merchant/user） |
| material_images | JSON | | 物料照片 URL 数组【撤单流程新增】；可含 source 标记（merchant/user） |
| objective_answers | JSON | | 客观题答案（报价/维修过程/完工验收各维度）【评价体系新增】 |
| reward_amount | DECIMAL(10,2) | | 奖励金金额【评价体系新增】 |
| tax_deducted | DECIMAL(10,2) | DEFAULT 0 | 代扣个税【评价体系新增】 |
| rating | TINYINT UNSIGNED | | 综合评分 1–5（选填，不影响奖励） |
| ratings_quality | TINYINT UNSIGNED | | 维修质量 |
| ratings_price | TINYINT UNSIGNED | | 价格透明 |
| ratings_service | TINYINT UNSIGNED | | 服务态度 |
| ratings_speed | TINYINT UNSIGNED | | 维修速度 |
| ratings_parts | TINYINT UNSIGNED | | 配件质量 |
| content | TEXT | | 评价内容 |
| before_images | JSON | | 维修前照片（可选冗余） |
| after_images | JSON | | 维修后照片 |
| ai_analysis | JSON | | AI 对比分析结果 |
| is_anonymous | TINYINT UNSIGNED | DEFAULT 0 | 0-否 1-是 |
| like_count | INT UNSIGNED | DEFAULT 0 | 点赞数 |
| content_quality_level | TINYINT UNSIGNED | DEFAULT 1 | 内容质量等级 1-4【点赞追加奖金体系】 |
| post_verify_like_count | INT UNSIGNED | DEFAULT 0 | 事后验证点赞数【点赞追加奖金体系】 |
| rebate_amount | DECIMAL(10,2) | DEFAULT 0 | 奖励金金额（兼容旧字段，新数据用 reward_amount） |
| rebate_rate | DECIMAL(4,2) | DEFAULT 0 | 奖励金比例（兼容，新规则用 reward_rules） |
| status | TINYINT UNSIGNED | DEFAULT 1 | 0-隐藏 1-显示 |
| created_at | DATETIME | | 创建时间 |
| updated_at | DATETIME | | 更新时间 |

**type 枚举**：1-首次评价、2-追评、3-返厂评价

**索引**：review_id, order_id, shop_id, user_id

---

### 4.8 transactions（交易记录表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGINT UNSIGNED | PK, AUTO_INCREMENT | 自增主键 |
| transaction_id | VARCHAR(32) | UNIQUE, NOT NULL | 业务主键 |
| user_id | VARCHAR(32) | NOT NULL, FK→users | 用户 ID |
| type | VARCHAR(20) | NOT NULL | rebate/withdraw/recharge/like_bonus 等 |
| amount | DECIMAL(10,2) | NOT NULL | 正数收入，负数支出 |
| reward_tier | TINYINT UNSIGNED | | 订单分级 1-4【评价体系新增】 |
| review_stage | VARCHAR(20) | | main/1m/3m【评价体系新增】 |
| tax_deducted | DECIMAL(10,2) | DEFAULT 0 | 代扣个税【评价体系新增】 |
| description | VARCHAR(200) | | 描述 |
| related_id | VARCHAR(32) | | 关联 ID（评价 ID、提现 ID 等） |
| created_at | DATETIME | | 创建时间 |

**type 枚举**：rebate-奖励金、withdraw-提现、recharge-充值、like_bonus-常规点赞追加奖金

**索引**：transaction_id, user_id, type

---

### 4.8a review_reading_sessions（评价有效阅读会话）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGINT UNSIGNED | PK, AUTO_INCREMENT | 自增主键 |
| session_id | VARCHAR(32) | UNIQUE, NOT NULL | 业务主键 |
| review_id | VARCHAR(32) | NOT NULL, FK→reviews | 评价 ID |
| user_id | VARCHAR(32) | NOT NULL, FK→users | 浏览用户 |
| effective_seconds | INT UNSIGNED | NOT NULL | 本次有效阅读秒数（单次最多 180） |
| saw_at | DATETIME | | 「看到了」的时刻 |
| ended_at | DATETIME | | 会话结束 |
| created_at | DATETIME | | 创建时间 |

**索引**：(review_id, user_id), (user_id, review_id)

---

### 4.8b review_likes（评价点赞记录）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGINT UNSIGNED | PK, AUTO_INCREMENT | 自增主键 |
| like_id | VARCHAR(32) | UNIQUE, NOT NULL | 业务主键 |
| review_id | VARCHAR(32) | NOT NULL, FK→reviews | 评价 ID |
| user_id | VARCHAR(32) | NOT NULL, FK→users | 点赞用户 |
| effective_reading_seconds | INT UNSIGNED | DEFAULT 0 | 点赞时累计有效阅读时长 |
| like_type | VARCHAR(20) | DEFAULT 'normal' | normal/post_verify |
| is_valid_for_bonus | TINYINT UNSIGNED | DEFAULT 0 | 是否纳入奖金核算 |
| weight_coefficient | DECIMAL(6,4) | DEFAULT 0 | 账号综合权重系数 |
| vehicle_match_by_plate | TINYINT UNSIGNED | DEFAULT 0 | 车型匹配 1=车牌一致 |
| created_at | DATETIME | | 创建时间 |

**唯一约束**：(user_id, review_id)

**索引**：review_id, user_id

---

### 4.9 withdrawals（提现申请表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGINT UNSIGNED | PK, AUTO_INCREMENT | 自增主键 |
| withdraw_id | VARCHAR(32) | UNIQUE, NOT NULL | 业务主键 |
| user_id | VARCHAR(32) | NOT NULL, FK→users | 用户 ID |
| amount | DECIMAL(10,2) | NOT NULL | 提现金额 |
| status | TINYINT UNSIGNED | DEFAULT 0 | 0-处理中 1-已完成 2-失败 |
| remark | VARCHAR(200) | | 备注 |
| processed_at | DATETIME | | 处理时间 |
| created_at | DATETIME | | 创建时间 |

**索引**：withdraw_id, user_id

---

### 4.10 user_messages（用户消息表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGINT UNSIGNED | PK, AUTO_INCREMENT | 自增主键 |
| message_id | VARCHAR(32) | UNIQUE, NOT NULL | 业务主键 |
| user_id | VARCHAR(32) | NOT NULL, FK→users | 用户 ID |
| type | VARCHAR(20) | NOT NULL | system/bidding/order/review |
| title | VARCHAR(100) | NOT NULL | 标题 |
| content | TEXT | | 内容 |
| related_id | VARCHAR(32) | | 关联竞价/订单/评价 ID |
| is_read | TINYINT UNSIGNED | DEFAULT 0 | 0-未读 1-已读 |
| created_at | DATETIME | | 创建时间 |

**索引**：message_id, user_id, (user_id, is_read)

---

### 4.11 user_favorite_shops（用户收藏维修厂表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGINT UNSIGNED | PK, AUTO_INCREMENT | 自增主键 |
| user_id | VARCHAR(32) | NOT NULL, FK→users | 用户 ID |
| shop_id | VARCHAR(32) | NOT NULL, FK→shops | 维修厂 ID |
| created_at | DATETIME | | 创建时间 |

**唯一约束**：(user_id, shop_id)

**索引**：user_id, shop_id

---

### 4.12 merchant_users（服务商账号表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGINT UNSIGNED | PK, AUTO_INCREMENT | 自增主键 |
| merchant_id | VARCHAR(32) | UNIQUE, NOT NULL | 业务主键 |
| shop_id | VARCHAR(32) | NOT NULL, FK→shops | 维修厂 ID |
| phone | VARCHAR(20) | NOT NULL | 登录手机号 |
| password_hash | VARCHAR(255) | | 密码哈希 |
| openid | VARCHAR(64) | | 微信 openid（可选） |
| status | TINYINT UNSIGNED | DEFAULT 1 | 0-禁用 1-启用 |
| created_at | DATETIME | | 创建时间 |
| updated_at | DATETIME | | 更新时间 |

**索引**：merchant_id, shop_id, phone

---

### 4.13 shop_penalties（维修厂惩罚记录表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGINT UNSIGNED | PK, AUTO_INCREMENT | 自增主键 |
| shop_id | VARCHAR(32) | NOT NULL, FK→shops | 维修厂 ID |
| order_id | VARCHAR(32) | | 关联订单 |
| deviation_rate | DECIMAL(5,2) | | 偏差率(%) |
| penalty_type | VARCHAR(20) | NOT NULL | warning/deduction/suspend |
| penalty_detail | VARCHAR(200) | | 惩罚说明 |
| suspend_until | DATETIME | | 暂停至何时（竞价资格） |
| created_at | DATETIME | | 创建时间 |

**索引**：shop_id, created_at

---

### 4.14 settings（系统配置表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INT UNSIGNED | PK, AUTO_INCREMENT | 自增主键 |
| key | VARCHAR(50) | UNIQUE, NOT NULL | 配置键 |
| value | TEXT | | 配置值 |
| description | VARCHAR(200) | | 描述 |
| updated_at | DATETIME | | 更新时间 |

**默认配置**：见 schema.sql 中的 INSERT。

**评价体系相关配置**（key 示例）：

| key | 说明 |
|-----|------|
| require_settlement_before_review | 是否需等分账完成才允许评价/返现，0-否 1-是 |
| reward_rules | 奖励金三级校准规则（JSON 或拆分为多 key） |

---

### 4.15 repair_complexity_levels（维修项目复杂度等级表）【评价体系新增】

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INT UNSIGNED | PK, AUTO_INCREMENT | 自增主键 |
| level | VARCHAR(10) | NOT NULL | L1/L2/L3/L4 |
| project_type | VARCHAR(100) | NOT NULL | 维修项目类型（交通部国标分类） |
| fixed_reward | DECIMAL(10,2) | NOT NULL | 固定奖励（元） |
| float_ratio | DECIMAL(4,2) | NOT NULL | 浮动比例(%) |
| cap_amount | DECIMAL(10,2) | NOT NULL | 单项目封顶（元） |
| created_at | DATETIME | | 创建时间 |

**索引**：level, project_type

---

### 4.16 reward_rules（奖励金规则配置表）【评价体系新增】

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INT UNSIGNED | PK, AUTO_INCREMENT | 自增主键 |
| rule_key | VARCHAR(50) | UNIQUE, NOT NULL | 规则键 |
| rule_value | JSON/TEXT | | 规则值（订单分级阈值、车型系数等） |
| description | VARCHAR(200) | | 描述 |
| updated_at | DATETIME | | 更新时间 |

---

### 4.17 review_dimensions（评价维度记录表）【评价体系新增】

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGINT UNSIGNED | PK, AUTO_INCREMENT | 自增主键 |
| review_id | VARCHAR(32) | NOT NULL | 评价 ID |
| dimension | VARCHAR(20) | NOT NULL | quote/process/completion（报价/维修过程/完工验收） |
| score | TINYINT UNSIGNED | | 该维度得分 1–5 |
| answers | JSON | | 客观题答案 |
| images | JSON | | 该维度相关图片 URL |
| created_at | DATETIME | | 创建时间 |

**索引**：review_id, dimension

---

### 4.18 review_audit_logs（评价审核留痕表）【评价体系新增】

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGINT UNSIGNED | PK, AUTO_INCREMENT | 自增主键 |
| review_id | VARCHAR(32) | NOT NULL | 评价 ID |
| audit_type | VARCHAR(20) | NOT NULL | ai/manual |
| result | VARCHAR(20) | NOT NULL | pass/reject |
| missing_items | JSON | | 缺项说明（不通过时） |
| operator_id | VARCHAR(32) | | 人工复核操作人 |
| created_at | DATETIME | | 创建时间 |

**索引**：review_id, created_at

---

### 4.19 complexity_upgrade_requests（破格升级申请表）【评价体系新增】

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGINT UNSIGNED | PK, AUTO_INCREMENT | 自增主键 |
| request_id | VARCHAR(32) | UNIQUE, NOT NULL | 业务主键 |
| order_id | VARCHAR(32) | NOT NULL | 订单 ID |
| user_id | VARCHAR(32) | NOT NULL | 用户 ID |
| current_level | VARCHAR(10) | | 当前复杂度等级 |
| requested_level | VARCHAR(10) | NOT NULL | 申请等级 |
| reason | TEXT | | 申请理由 |
| status | TINYINT UNSIGNED | DEFAULT 0 | 0-待审核 1-通过 2-拒绝 |
| auditor_id | VARCHAR(32) | | 审核人 |
| audited_at | DATETIME | | 审核时间 |
| created_at | DATETIME | | 创建时间 |

**索引**：request_id, user_id, status

---

## 5. 核心业务规则（数据库相关）

| 规则 | 说明 |
|------|------|
| 偏差率计算 | `|actual_amount - quoted_amount| / quoted_amount * 100`，在订单完成时写入 orders.deviation_rate |
| 奖励金规则 | 按《全指标底层逻辑梳理.md》第四章（基础×车价校准×复杂度校准+浮动），来自 repair_complexity_levels、reward_rules |
| 流程触发 | 默认「用户确认完工 + 平台分账完成」后弹出主评价；require_settlement_before_review=0 时可提前弹出 |
| 分账与评价 | require_settlement_before_review=1 时需分账完成才允许评价；=0 时可提前返现 |
| AI 审核 | 主评价提交后 AI 秒级初审，通过立即触发奖励发放；异议/大额/异常订单启动人工复核，留痕于 review_audit_logs |
| 奖励发放时机 | 一级/二级：主评价通过 100%；三级：主评价 50% + 1 个月追评 50%；四级：主评价 50% + 1 个月 30% + 3 个月 20% |
| 佣金比例 | 按车型分级、复杂度分级，来自 reward_rules；原 12% 为默认 |
| 竞价有效期 | 24 小时，来自 settings |
| 提现限制 | 最低 10 元，单日最高 5000 元 |
| 惩罚机制 | 见需求文档 4.3，通过 shop_penalties 记录，suspend_until 控制竞价资格 |

---

## 6. 与 Schema 文件对应关系

| 文档章节 | 对应 SQL |
|----------|----------|
| 4.1–4.9 | web/database/schema.sql 表 1–9 |
| 4.10–4.14 | web/database/schema.sql 表 10–14 |
| 4.15–4.19 | web/database/schema.sql 表 15–19（评价体系新增，需补充 migration） |

**执行顺序**：直接执行 `schema.sql` 即可完成建表和初始化。评价体系新增表与字段需通过 migration 或补充 schema 后执行。

---

## 7. 修订记录

| 版本 | 日期 | 说明 |
|------|------|------|
| v1.0 | 2026-02-11 | 初稿，完整设计 |
| v1.1 | 2026-02-11 | 评价和激励体系：新增 repair_complexity_levels、reward_rules、review_dimensions、review_audit_logs、complexity_upgrade_requests；扩展 orders、reviews、shops、transactions、settings |
| v1.2 | 2026-02-11 | 追评时间：7 天/30 天 → 1 个月/3 个月，给车主足够时间发现问题；review_stage 枚举 7d/30d → 1m/3m |
| v1.3 | 2026-02 | 撤单流程：orders 新增 accepted_at、completion_evidence；新增 order_cancel_requests；维修完成凭证必传；评价预填服务商凭证并标记来源 |
| v1.4 | 2026-02-24 | 点赞追加奖金体系：新增 review_reading_sessions、review_likes；reviews 新增 content_quality_level、post_verify_like_count；transactions.type 扩展 like_bonus；月度核算任务已取消 |
| v1.5 | 2026-02-27 | 月度定期结算：新增 reward_settlement_pending、reward_settlement_logs；transactions 扩展 settlement_month、conversion_bonus、post_verify_bonus；新增 post_verify_settled_orders 防事后验证重复发放 |
