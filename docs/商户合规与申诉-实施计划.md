# 商户合规与申诉 - 实施计划

> 依据用户确认：材料 AI 审核、客观题选「否」商户申诉、第 3 题用户举证与商户申诉、扣分标准与合规率换算。

---

## 一、需求概要

| 模块 | 说明 |
|------|------|
| **材料 AI 审核** | 服务商点击「维修完成」上传的材料，经 AI 审核；不通过则 1→2 拒绝 |
| **第 1、2 题商户申诉** | 用户选「否」→ 通知服务商 → 48h 内申诉 → 申诉不利则扣分 |
| **第 3 题** | 举证责任在用户（选填）；用户举证故障未解决 → 提升评价等级；商户可申诉，48h，AI 初审 + 人工复核 |
| **扣分与合规率** | 单笔扣分 → 汇总为季度综合合规率 → 按 05 文档影响店铺得分 |

---

## 二、扣分标准（优先 .cursor/rules，无则参考评价内容设置规范）

.cursor/rules 无具体扣分，采用《评价内容设置规范》：

| 违规事项 | 扣分 | 来源 |
|----------|------|------|
| 用户选「否」进度未同步，商户 48h 内申诉不利 | 5 分/单 | 评价内容设置规范 |
| 用户选「否」未展示新旧配件，商户 48h 内申诉不利 | 15 分/单 | 评价内容设置规范 |
| 材料 AI 审核不通过 | 1→2 拒绝，不进入完成 | 不产生扣分（订单未完成） |

注：质保、工期、系统核验违规等按规范另有扣分，本计划聚焦「客观题申诉」与「材料审核」。

---

## 三、合规率与店铺得分（05 文档）

**季度综合合规率** = 本季度合规订单数 / 本季度总完成订单数 × 100%

- **合规订单**：无「商户申诉不利」等违规扣分记录的订单
- **违规订单**：用户选「否」且商户 48h 内申诉不利的订单

**硬指标加减分**（05 文档三、硬指标加减分项）：

| 季度综合合规率 | 店铺得分影响 |
|----------------|--------------|
| ≥95% | +10 分 |
| 80%–94% | 不加减 |
| ＜80% | 扣 20 分 |

---

## 四、实现顺序（建议）

### 阶段 1：材料 AI 审核（优先）

**原因**：在 1→2 入口拦截不合规材料，避免进入后续流程。

| 工作项 | 说明 |
|--------|------|
| 新增材料审核 AI 能力 | 千问 Vision：校验结算单真实性、与订单匹配；施工图与维修项目匹配；材料合规 |
| 1→2 流程改造（**异步**） | 数量校验通过 → 写入 completion_evidence，status 保持 1，新增「材料审核中」标记 → 返回「材料审核中，请稍后查看结果」 |
| 后台异步任务 | 调用 AI 审核 → 通过则 status=2（待确认）；不通过则记录原因，通知服务商修改后重试 |
| 订单状态 | 可选：新增 `material_audit_status`（pending/passed/rejected）或复用 `completion_evidence` 元数据 |
| 审核失败 | 通知服务商具体原因，服务商修改后重新提交 |

### 阶段 2：商户申诉机制（第 1、2 题）

**原因**：评价提交后需立即触发申诉流程，依赖数据与通知。

| 工作项 | 说明 |
|--------|------|
| 申诉任务表 | merchant_evidence_requests：order_id, review_id, question_key, status, deadline, evidence_urls, created_at |
| 评价提交后 | 若 q1_progress_synced=false 或 q2_parts_shown=false，创建申诉任务，deadline=now+48h |
| 通知 | **站内消息**（必做）：通知服务商「需对评价中的 XX 项申诉」，含申诉入口；**公众号**（接口预留，待接入后启用） |
| 服务商申诉 | 上传材料，AI 初审是否有效 |
| 到期处理 | 定时任务：deadline 到期未申诉 → 记录违规扣分，更新店铺合规相关数据 |

### 阶段 3：合规率汇总与店铺更新

| 工作项 | 说明 |
|--------|------|
| 违规记录表 | shop_violations：shop_id, order_id, violation_type, penalty, created_at |
| 季度合规率计算 | 按 shop_id、季度统计：合规率 = (完成订单数 - 违规订单数) / 完成订单数 |
| 更新 shops.compliance_rate | 定时任务或事件触发 |
| shop-score 集成 | calcHardBonus 已读 compliance_rate，无需改 |

### 阶段 4：第 3 题用户举证与商户申诉

**原因**：涉及用户端举证入口、商户申诉、AI+人工复核，流程最复杂。

| 工作项 | 说明 |
|--------|------|
| 用户举证（选填） | 评价页选「否」时引导上传故障凭证；上传则提升内容等级 |
| 商户申诉 | 用户选「否」→ 站内消息+公众号（预留）通知服务商 → **从通知发送起 48h** 内可申诉（提供竣工检验、检测报告等） |
| AI 初审 | 对商户申诉材料做形式校验 |
| 人工复核 | 复杂 case 转人工，3 个工作日内处理 |
| 结果 | 确认为恶意差评 → 剔除该题权重；否则维持 |

---

## 五、通知设计

| 渠道 | 实现 | 说明 |
|------|------|------|
| **站内消息** | 必做 | 服务商端消息中心，申诉通知、材料审核结果等 |
| **公众号** | 接口预留 | 暂未接入，预留 `sendMerchantNotification(type, shopId, payload)` 等接口，待公众号配置后启用 |

---

## 六、数据库设计（草案）

### merchant_evidence_requests（商户申诉任务）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| request_id | VARCHAR(32) | 业务主键 |
| order_id | VARCHAR(32) | 订单 ID |
| review_id | VARCHAR(32) | 评价 ID |
| shop_id | VARCHAR(32) | 店铺 ID |
| question_key | VARCHAR(32) | q1_progress_synced / q2_parts_shown |
| status | TINYINT | 0 待申诉 1 已申诉待审核 2 申诉有效 3 申诉无效/超时 |
| deadline | DATETIME | 截止时间（通知发送 + 48h） |
| evidence_urls | JSON | 申诉材料 URL 数组 |
| ai_result | VARCHAR(50) | AI 初审结果 |
| created_at | DATETIME | 创建时间 |

### shop_violations（店铺违规记录）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| shop_id | VARCHAR(32) | 店铺 ID |
| order_id | VARCHAR(32) | 订单 ID |
| violation_type | VARCHAR(50) | progress_not_synced / parts_not_shown |
| penalty | INT | 扣分 5/15 |
| created_at | DATETIME | 创建时间 |

---

## 七、已确认项

| 项 | 结论 |
|----|------|
| 第 3 题 48h | 从给服务商发送公众号/站内通知开始计时，商户申诉窗口 48h |
| 材料 AI 审核 | **异步**：1→2 先返回「审核中」，后台审核完成后回调更新状态 |
| 通知渠道 | 暂未接入公众号，**保留公众号接口预留**，**同时实现站内消息** |

---

## 八、已实现（2026-02-26）

### 阶段 1：材料 AI 审核 ✅

| 文件 | 说明 |
|------|------|
| `web/database/migration-20260226-material-audit.sql` | material_audit_tasks 表 |
| `web/api-server/qwen-analyzer.js` | analyzeCompletionEvidenceWithQwen |
| `web/api-server/services/material-audit-service.js` | 异步审核、站内消息 |
| `web/api-server/services/order-service.js` | 1→2 改为创建审核任务，返回 auditing |
| `web/api-server/server.js` | PUT status 触发异步审核；订单详情返回 material_audit_status |

### 阶段 2：商户申诉 ✅

| 文件 | 说明 |
|------|------|
| `web/database/migration-20260226-merchant-evidence.sql` | merchant_evidence_requests、shop_violations 表 |
| `web/api-server/review-service.js` | 评价提交后 q1/q2 为 false 时创建申诉任务、发站内消息 |
| `web/api-server/services/merchant-evidence-service.js` | 逾期处理、合规率更新、申诉列表、提交申诉 |
| `web/api-server/server.js` | GET /api/v1/merchant/appeals、POST /api/v1/merchant/appeals/:id/submit、cron |
| `web/scripts/cron-process-overdue-evidence.sh` | 定时任务脚本 |

**服务商申诉入口**：
- `GET /api/v1/merchant/appeals?status=0` 待申诉列表
- `POST /api/v1/merchant/appeals/:requestId/submit` 提交申诉材料 `{ evidence_urls: string[] }`，提交后异步 AI 初审

**申诉 AI 初审**：
- 提交后 fire-and-forget 调用千问 Vision 审核材料有效性
- 通过 → status=2（申诉有效）；不通过 → status=3，写入 shop_violations，通知服务商
- 复杂 case 转人工 → status=4（待人工复核），通知服务商「预计 3 个工作日内处理」
- 补漏 cron：`POST /api/v1/admin/cron/process-pending-appeals` 处理 status=1

**人工复核**（status=4）：
- 管理端 `/admin/appeal-reviews` 列表待复核申诉
- `GET /api/v1/admin/appeal-reviews` 列表；`POST /api/v1/admin/appeal-reviews/:requestId/resolve` { approved: true/false }

### 阶段 4：第 3 题用户举证与商户申诉 ✅

| 文件 | 说明 |
|------|------|
| `web/database/migration-20260226-q3-fault-evidence.sql` | fault_evidence_images、q3_weight_excluded |
| `pages/review/submit/*` | 第 3 题选否时显示故障凭证上传（选填） |
| `web/api-server/review-service.js` | 存储 fault_evidence_images；q3 选否创建申诉任务 |
| `web/api-server/services/merchant-evidence-service.js` | q3 逾期不扣分；q3 申诉有效→q3_weight_excluded=1 |

### 部署步骤

1. 执行迁移：`mysql -u root -p chelizi < web/database/migration-20260226-material-audit.sql`  
   `mysql -u root -p chelizi < web/database/migration-20260226-merchant-evidence.sql`  
   `mysql -u root -p chelizi < web/database/migration-20260226-q3-fault-evidence.sql`  
   `mysql -u root -p chelizi < web/database/migration-20260226-appeal-status4.sql`
2. 上传代码并重启 API 服务
3. 配置 crontab：每小时执行 `cron-process-overdue-evidence.sh`（见 `web/scripts/crontab.example`）
