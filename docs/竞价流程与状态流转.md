# 竞价流程与状态流转

## 1. 概述

本文档描述从用户提交竞价到竞价结束的完整流程，涵盖所有状态、触发条件及数据变更。

---

## 2. 核心实体与状态定义

### 2.1 竞价 (biddings)

| 字段 | 说明 |
|------|------|
| bidding_id | 竞价唯一 ID |
| user_id | 发起人（车主） |
| report_id | 定损报告 ID（必填，外键） |
| status | 0=进行中 1=已结束 2=已取消 |
| expire_at | 过期时间（创建时 +24h） |
| selected_shop_id | 选中的维修厂 ID（成交时写入） |

### 2.2 报价 (quotes)

| 字段 | 说明 |
|------|------|
| quote_id | 报价唯一 ID |
| bidding_id | 所属竞价 |
| shop_id | 报价维修厂 |
| quote_status | 0=有效 1=成交 2=已失效 |

### 2.3 订单 (orders)

| 字段 | 说明 |
|------|------|
| order_id | 订单唯一 ID |
| bidding_id | 来源竞价 |
| status | 0=待接单 1=维修中 2=待验收 3=已完成 4=已取消 |

---

## 3. 完整流程与状态流转

### 3.1 流程总览

```
[用户发起竞价] → [竞价进行中] → [结束路径 A/B/C/D]
                    │
                    ├─ 服务商在范围内可见
                    ├─ 服务商提交报价 (quote_status=0)
                    └─ 用户操作：选厂 / 结束 / 过期
```

### 3.2 阶段一：竞价创建

| 步骤 | 触发 | 数据变更 | 备注 |
|------|------|----------|------|
| 1 | 用户完成 AI 定损，点击发起竞价 | INSERT biddings (status=0, expire_at=NOW+24h) | report_id 必填 |
| 2 | 创建时传入 latitude/longitude | UPDATE users SET latitude, longitude | 用于服务商距离筛选，无则附近服务商看不到 |

**前置条件**：report_id 存在且属于当前用户。

### 3.3 阶段二：竞价进行中 (biddings.status=0)

#### 3.3.1 服务商可见性

服务商能看到某竞价的条件（同时满足）：

1. `biddings.status = 0`
2. `biddings.expire_at > NOW()`
3. `users.latitude IS NOT NULL AND users.longitude IS NOT NULL`（车主有位置）
4. `shops.latitude IS NOT NULL AND shops.longitude IS NOT NULL`（店铺有位置）
5. 距离：`haversine(用户位置, 店铺位置) <= biddings.range_km`

#### 3.3.2 服务商 Tab 分类（同一套筛选逻辑）

| Tab | 条件 | 说明 |
|-----|------|------|
| 待报价 (pending) | 上述可见性 + 本店未报价 | 可进入详情并提交报价 |
| 已报价 (quoted) | 上述可见性 + 本店已报价 | 可查看自己的报价 |
| 已结束 (ended) | biddings.status=1 + 本店有报价 | 可查看成交/已失效状态 |

#### 3.3.3 服务商提交报价

| 步骤 | 触发 | 数据变更 | 校验 |
|------|------|----------|------|
| 1 | 服务商提交报价 | INSERT quotes (quote_status=0) | 竞价 status=0；本店未报价；本店在范围内；资质已通过 |

### 3.4 阶段三：竞价结束（四种路径）

#### 路径 A：用户选择某家报价（成交）

| 步骤 | 触发 | 数据变更 |
|------|------|----------|
| 1 | 用户点击「选择」某维修厂 | INSERT orders (status=0 待接单) |
| 2 | | UPDATE quotes SET quote_status=1 WHERE 选中店 |
| 3 | | UPDATE quotes SET quote_status=2 WHERE 其他店 |
| 4 | | UPDATE biddings SET status=1, selected_shop_id=选中店 |
| 5 | | INSERT merchant_messages (新订单待接单) |

**结果**：竞价结束，订单生成，选中店报价成交，其他店报价已失效。

#### 路径 B：用户主动结束（未选任何报价）

| 步骤 | 触发 | 数据变更 |
|------|------|----------|
| 1 | 用户点击「结束竞价」并确认 | UPDATE biddings SET status=1 |
| 2 | | UPDATE quotes SET quote_status=2 WHERE bidding_id=? |

**结果**：竞价结束，所有报价已失效，无订单。

#### 路径 C：竞价过期

| 步骤 | 触发 | 数据变更 |
|------|------|----------|
| 1 | expire_at 到达（当前无定时任务自动更新） | 查询时通过 expire_at > NOW() 过滤，过期竞价视为「已结束」 |

**说明**：若需自动将过期竞价 status 置为 1，需增加定时任务。

#### 路径 D：订单取消后竞价重开

| 步骤 | 触发 | 数据变更 |
|------|------|----------|
| 1 | 用户取消订单（24h 内） | UPDATE orders SET status=4 |
| 2 | | UPDATE biddings SET status=0, selected_shop_id=NULL |

**结果**：竞价重新进行中，用户可再次选厂。

---

## 4. 工作台与列表一致性

### 4.1 原则

**工作台「待报价」数量** 与 **竞价列表「待报价」Tab 的 total** 必须来自**同一套查询逻辑**。

### 4.2 统一筛选条件（待报价）

```sql
biddings.status = 0
AND biddings.expire_at > NOW()
AND users.latitude IS NOT NULL AND users.longitude IS NOT NULL
AND shops.latitude IS NOT NULL AND shops.longitude IS NOT NULL
AND haversine(用户, 店铺) <= biddings.range_km
AND NOT EXISTS (SELECT 1 FROM quotes WHERE bidding_id=b.bidding_id AND shop_id=?)
```

### 4.3 实现方式

将上述逻辑封装为 `bidding-service.js` 中的统一函数，dashboard 与 merchant/biddings 均调用，保证 count 与 list 一致。

---

## 5. 异常与边界

| 场景 | 处理 |
|------|------|
| 用户无位置发起竞价 | 创建成功，但服务商端不展示（距离无法计算） |
| 店铺无位置 | 不展示该店铺 |
| 竞价已结束仍尝试报价 | 400 该竞价已结束 |
| 本店已报价仍尝试报价 | 400 您已提交过报价 |
| 本店不在范围内访问详情 | 404 竞价不存在或未邀请您 |
| 用户结束竞价时已有报价 | 提示「现有报价都会作废」 |

---

## 6. 日志要点

关键节点需记录：

- 竞价创建：bidding_id, user_id, report_id, range_km, 是否有位置
- 报价提交：bidding_id, shop_id, amount
- 用户选厂：bidding_id, shop_id, order_id
- 用户结束：bidding_id
- 服务商列表查询：shop_id, status, 返回 count/list.length
