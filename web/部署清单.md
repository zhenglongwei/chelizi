# 车厘子 - 部署清单

**服务器目录**：`/var/www/simplewin`  
**目标结构**：与现有 api-server + assets 一致

---

## 一、文件上传位置对照表

| 本地上传源 | 服务器目标路径 |
|-----------|----------------|
| `web/api-server/server.js` | `/var/www/simplewin/api-server/server.js` |
| `web/api-server/package.json` | `/var/www/simplewin/api-server/package.json` |
| `web/api-server/uploads/`（上传目录） | 实际写入 `/var/www/simplewin/uploads/`（与根目录同级，便于公网访问） |
| `web/api-server/package-lock.json` | `/var/www/simplewin/api-server/package-lock.json` |
| `web/.env` | `/var/www/simplewin/.env` |
| `web/database/schema.sql` | `/var/www/simplewin/database/schema.sql`（用于初始化） |
| `web/database/migration-20260226-material-audit.sql` | `/var/www/simplewin/database/` |
| `web/database/migration-20260226-merchant-evidence.sql` | `/var/www/simplewin/database/` |
| `web/database/migration-20260226-q3-fault-evidence.sql` | `/var/www/simplewin/database/` |
| `web/scripts/cron-send-delayed-bidding-messages.sh` | `/var/www/simplewin/scripts/` |
| `web/scripts/cron-process-overdue-evidence.sh` | `/var/www/simplewin/scripts/` |
| `web/scripts/cron-process-pending-appeals.sh` | `/var/www/simplewin/scripts/` |
| `web/scripts/cron.env.example` | `/var/www/simplewin/scripts/` |
| `web/dist/index.html` | `/var/www/simplewin/index.html`（根目录） |
| `web/dist/index-*.js`、`web/dist/index-*.css` | `/var/www/simplewin/assets/` |

> **说明**：
> - `.env` 放在 `/var/www/simplewin/` 下（与 api-server 同级），因为 server.js 使用 `path: '../.env'`
> - **管理后台**：`index.html` 放根目录，JS/CSS 放 `assets/` 子目录（Vite 已配置 `base: '/assets/'`）
> - 本地的 `api-server/node_modules` 无需上传，在服务器上执行 `npm install` 生成
> - **图片上传 / AI 定损** 依赖 `multer`，若 `npm install` 后仍缺少该包，可单独执行：`npm install multer`
> - **上传目录**：图片保存到 `/var/www/simplewin/uploads/`（与 simplewin 根目录同级），需确保该目录存在且 Nginx/静态服务将 `/uploads` 映射到此路径，以便千问 API 可公网下载图片

---

## 二、构建管理后台（本地执行）

在部署前，需先在本地构建管理后台：

```bash
cd c:\Users\longwei\WeChatProjects\chelizi\web
npm run build
```

构建完成后，`web/dist/` 内会生成：
- `index.html`
- `index-xxx.js`、`index-xxx.css`

**部署时**：
- 将 `index.html` 上传到 `/var/www/simplewin/`（根目录）
- 将 `index-xxx.js`、`index-xxx.css` 上传到 `/var/www/simplewin/assets/`

---

## 三、服务器操作步骤

### 步骤 1：上传文件

将上述文件按「一、文件上传位置对照表」上传到对应路径。

### 步骤 2：初始化数据库（需输入密码）

```bash
cd /var/www/simplewin
mysql -u root -p < database/schema.sql
```

出现提示时输入 MySQL root 密码。

> **已有数据库升级**：若此前已初始化过 schema，需执行增量迁移：
> ```bash
> mysql -u root -p chelizi < database/migration-20260226-material-audit.sql
> mysql -u root -p chelizi < database/migration-20260226-merchant-evidence.sql
> mysql -u root -p chelizi < database/migration-20260226-q3-fault-evidence.sql
> ```

### 步骤 3：安装 API 依赖并启动

```bash
cd /var/www/simplewin/api-server
npm install --production
node server.js
```

或使用 pm2 保持运行：

```bash
cd /var/www/simplewin/api-server
npm install --production
pm2 start server.js --name chelizi-api
pm2 save
```

### 步骤 4：验证

- **API 健康检查**：`curl http://localhost:3000/health`
- **附近维修厂**：`curl "http://localhost:3000/api/v1/shops/nearby?limit=5"`

---

## 四、Nginx 配置（若用反向代理）

`conf.d/` 下的文件**只写 server 块**，不要包含 `user`、`worker_processes` 等主配置。参考 `web/nginx-simplewin.conf.example`，将内容写入 `/etc/nginx/conf.d/simplewin.conf`：

```nginx
server {
    listen 80;
    server_name simplewin.cn www.simplewin.cn;

    location /api {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location / {
        root /var/www/simplewin;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
}
```

**注意**：`proxy_pass` 不要带路径（如 `http://127.0.0.1:3000/`），否则会剥离 `/api` 导致 404「接口不存在」。

修改后执行 `nginx -t` 校验，再 `systemctl reload nginx`。

---

## 五、.env 检查项

上传前确认 `web/.env` 中至少包含：

- `DB_HOST`、`DB_USER`、`DB_PASSWORD`、`DB_NAME`
- `JWT_SECRET`
- `WX_APPID`、`WX_SECRET`（小程序登录）
- `VITE_API_BASE_URL`（管理端 API 地址，需与小程序一致，如 `https://simplewin.cn/api`）
- `CRON_SECRET`（可选，用于竞价第二/第三梯队消息定时补发，见下方）

---

## 五a、竞价第二/第三梯队消息补发（定时任务，可选）

第二、第三梯队消息有两种触发方式：

1. **首次请求时**（已内置）：服务商打开「待报价」列表时自动补发，无需配置。
2. **定时任务**：使用 `web/scripts/` 下脚本，详见 `web/scripts/README-cron.md`。

**快速配置**：
```bash
# 1. 上传脚本到服务器后
cd /var/www/simplewin/scripts
cp cron.env.example cron.env
# 编辑 cron.env，填写 CRON_SECRET（与 .env 一致）

# 2. 在 .env 中设置 CRON_SECRET

# 3. 赋予执行权限并添加 crontab
chmod +x cron-send-delayed-bidding-messages.sh
crontab -e
# 添加：*/2 * * * * /var/www/simplewin/scripts/cron-send-delayed-bidding-messages.sh >> /var/log/chelizi-cron.log 2>&1
```

---

## 六、快速命令汇总

```bash
# 1. 初始化数据库（会提示输入密码）
mysql -u root -p < /var/www/simplewin/database/schema.sql

# 2. 安装依赖并启动 API
cd /var/www/simplewin/api-server && npm install --production && node server.js

# 3. 使用 pm2
cd /var/www/simplewin/api-server && pm2 start server.js --name chelizi-api
```

---

## 七、前端 404 故障排查（index-xxx.js 找不到）

**现象**：浏览器访问 https://simplewin.cn 时，控制台或网络面板显示 `index-xxx.js` 或 `index-xxx.css` 返回 404。

**原因**：Vite 每次构建都会为 JS/CSS 生成新的 hash 文件名（如 `index-DHtkYv6l.js`）。若只上传了新的 index.html 而没上传对应的 JS，或只上传了 JS 而 index.html 仍引用旧文件名，就会 404。

**解决步骤**：

1. **本地重新构建**：
   ```bash
   cd web
   npm run build
   ```

2. **完整上传 dist 目录**：将 `web/dist/` 内**全部文件**（index.html、index-xxx.js、index-xxx.css）上传到服务器，覆盖旧文件。**必须保证 index.html 与 JS/CSS 来自同一次构建**。

3. **确认服务器目录结构**：
   - 若 Nginx `root` 为 `/var/www/simplewin/assets`，则 dist 内所有文件应直接放在 `assets/` 下（扁平结构）。
   - 若请求路径为 `/assets/index-xxx.js`，说明 Nginx `root` 可能是 `/var/www/simplewin`，此时需将 index.html 放在根目录，JS/CSS 放在 `assets/` 子目录。

4. **验证**：构建后查看 `dist/index.html` 中的 script/link 引用（如 `src="/index-BWMMFQh7.js"`），确认服务器上存在同名文件。

---

## 八、API 更新说明（部署后需更新 server.js）

若「我的竞价」页的「结束竞价」提示「接口不存在」，说明服务器上的 `server.js` 未包含最新接口。需重新上传 `web/api-server/server.js` 并重启 API 服务。

新增接口：`POST /api/v1/bidding/:id/end`（用户主动结束进行中的竞价）

---

## 九、开发测试：模拟报价（车主端竞价页测试）

服务商端尚未开发时，可用「模拟报价」测试竞价报价页完整流程：

1. **本地启动 API**（不设 `NODE_ENV=production`）：
   ```bash
   cd web/api-server && node server.js
   ```
2. **小程序 config.js** 指向本地 API（如 `BASE_URL: 'http://localhost:3000'`），或在微信开发者工具中勾选「不校验合法域名」。
3. **确保数据库有 shops 数据**：附近维修厂、搜索等接口会生成 shops，或执行 seed 脚本。
4. **发起竞价**：AI 定损 → 发起竞价 → 进入竞价报价页。
5. **生成测试报价**：在竞价报价页无报价时，点击「生成测试报价（开发用）」→ 接口会为当前竞价插入若干条测试报价（基于现有 shops）。
6. **验证流程**：查看报价列表、切换保险/自费排序、选择维修厂、跳转订单详情。

> **说明**：`POST /api/v1/dev/seed-quotes` 仅在 `NODE_ENV !== 'production'` 时注册，生产环境不会暴露此接口。
