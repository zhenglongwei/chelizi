<!-- 服务商订单详情 - M07 -->
<custom-nav-bar title="订单详情" showBack="{{true}}" />
<view class="page-root merchant-order-detail" style="{{pageRootStyle}}">
  <!-- 卡片1：订单状态 + 工期计时器 -->
  <view class="detail-section card" wx:if="{{order}}">
    <view class="section-head">
      <view class="section-title fs-body fw-medium">订单状态</view>
    </view>
    <view class="status-text">{{order.status_text}}</view>

    <!-- 工期计时器（待接单/维修中时显示） -->
    <view class="duration-timer-wrap" wx:if="{{order.status <= 1 && order.quote && order.quote.duration && order.duration_deadline}}">
      <view class="section-head">
        <view class="section-title fs-body fw-medium">施工期限</view>
      </view>
      <view class="duration-timer {{durationCountdownExpired ? 'expired' : ''}}">
        <view class="duration-timer-main">
          <text class="duration-days">工期 {{order.quote.duration}} 天</text>
          <text class="duration-deadline">至 {{order.duration_deadline_text}} 施工完毕</text>
        </view>
        <view class="duration-countdown" wx:if="{{!durationCountdownExpired}}">
          <text class="countdown-label">剩余</text>
          <text class="countdown-value">{{durationCountdownText}}</text>
        </view>
        <view class="duration-countdown expired" wx:else>
          <text class="countdown-value">已超期</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 卡片2：车辆信息 + 损伤情况 + 报价 + 维修建议 + 增值服务 + 车主 -->
  <view class="detail-section card" wx:if="{{order}}">
    <view class="section-head">
      <view class="section-title fs-body fw-medium">车辆信息</view>
    </view>
    <view class="vehicle-info text-muted fs-body">{{order.vehicle_info.brand || ''}} {{order.vehicle_info.model || ''}} {{order.vehicle_info.plate_number || ''}}</view>

    <!-- 损伤情况（来自定损报告） -->
    <view class="section-head" wx:if="{{order.analysis_result && order.analysis_result.damages && order.analysis_result.damages.length}}">
      <view class="section-title fs-body fw-medium">损伤情况</view>
    </view>
    <view class="damage-list" wx:if="{{order.analysis_result && order.analysis_result.damages && order.analysis_result.damages.length}}">
      <view class="damage-item" wx:for="{{order.analysis_result.damages}}" wx:key="index">
        <view wx:if="{{item.part && item.type}}" class="damage-item-row">
          <text class="fs-body">{{item.part}}：</text>
          <text class="text-muted fs-cap">{{item.type}}</text>
        </view>
        <block wx:elif="{{item.sub && item.sub.length}}">
          <view class="damage-sub" wx:for="{{item.sub}}" wx:for-item="sub" wx:key="index">
            <text class="fs-body">{{sub.damage_part || sub.name || sub.item}}</text>
            <text class="text-muted fs-cap">{{sub.repair_type || '维修'}}{{sub.repair_type === '换' && sub.parts_type ? ' · ' + sub.parts_type : ''}}</text>
          </view>
        </block>
        <view wx:else class="damage-item-row">
          <text class="fs-body">{{item.damage_part || item.name || item.part || item.item}}：</text>
          <text class="text-muted fs-cap">{{item.repair_type || item.type || '维修'}}</text>
        </view>
      </view>
    </view>

    <view class="section-head">
      <view class="section-title fs-body fw-medium">报价</view>
    </view>
    <view class="quote-info">
      <text class="text-gold fs-body fw-medium">¥{{order.displayAmount || order.quoted_amount}}</text>
      <text class="text-muted fs-cap" wx:if="{{order.displayDuration || order.displayWarranty || order.quote}}">，工期{{order.displayDuration || order.quote.duration}}天，质保{{order.displayWarranty || order.quote.warranty}}月</text>
    </view>

    <!-- 维修方案（接单后为正式方案，来自 repair_plan 或 quote） -->
    <view class="section-head section-head-with-action" wx:if="{{planItems.length}}">
      <view class="section-title fs-body fw-medium">{{order.status >= 1 ? '维修方案' : '维修建议'}}</view>
      <view class="section-more" wx:if="{{canEditPlan}}" bindtap="onEditPlan">修改方案</view>
    </view>
    <view class="repair-items" wx:if="{{planItems.length}}">
      <view class="repair-item" wx:for="{{planItems}}" wx:key="index">
        <text class="fs-body">{{item.damage_part || item.name || item.item}}</text>
        <text class="text-muted fs-cap">{{item.repair_type || '维修'}}{{item.repair_type === '换' && item.parts_type ? ' · ' + item.parts_type : ''}}</text>
      </view>
    </view>

    <!-- 增值服务 -->
    <view class="section-head" wx:if="{{planValueAdded.length}}">
      <view class="section-title fs-body fw-medium">增值服务</view>
    </view>
    <view class="value-added-list" wx:if="{{planValueAdded.length}}">
      <view class="value-added-item fs-body" wx:for="{{planValueAdded}}" wx:key="index">{{item.name || item}}</view>
    </view>

    <view class="order-tier-info text-muted fs-cap" wx:if="{{order.complexity_level || order.commission_rate}}">
      <text wx:if="{{order.complexity_level}}">复杂度 {{order.complexity_level}}</text>
      <text wx:if="{{order.commission_rate}}"> · 佣金 {{order.commission_rate}}</text>
    </view>
    <view class="section-head">
      <view class="section-title fs-body fw-medium">车主</view>
    </view>
    <view class="owner-info fs-body">{{order.owner_nickname || '车主'}} <text class="link" bindtap="onCallOwner" wx:if="{{order.owner_phone}}">拨打电话</text></view>
  </view>
  <!-- 撤单申请（服务商响应） -->
  <view class="detail-section card" wx:if="{{order && order.pending_cancel_request}}">
    <view class="section-head">
      <view class="section-title fs-body fw-medium">撤单申请</view>
    </view>
    <view class="cancel-reason text-muted fs-body">{{order.pending_cancel_request.reason}}</view>
    <view class="action-btns action-btns-row">
      <button class="btn-primary" bindtap="onRespondCancel" data-approve="{{true}}">同意撤单</button>
      <button class="btn-secondary" bindtap="onRespondCancel" data-approve="{{false}}">拒绝</button>
    </view>
  </view>

  <!-- 维修完成凭证（status=1 时必填） -->
  <view class="detail-section card" wx:if="{{order && order.status === 1}}">
    <view class="section-head">
      <view class="section-title fs-body fw-medium">维修完成凭证<text class="text-error">*</text></view>
    </view>
    <view class="evidence-upload">
      <view class="evidence-item">
        <text class="evidence-label fs-body">修复后照片（至少1张）</text>
        <view class="evidence-grid">
          <view class="evidence-thumb" wx:for="{{repairPhotoUrls}}" wx:key="index">
            <image src="{{item}}" mode="aspectFill"/>
            <view class="evidence-del" data-type="repair" data-index="{{index}}" bindtap="onDelEvidencePhoto">×</view>
          </view>
          <view class="evidence-add" wx:if="{{repairPhotoUrls.length < 6}}" bindtap="onChooseRepairPhoto">+</view>
        </view>
      </view>
      <view class="evidence-item">
        <text class="evidence-label fs-body">定损单/结算单（至少1张）</text>
        <view class="evidence-grid">
          <view class="evidence-thumb" wx:for="{{settlementPhotoUrls}}" wx:key="index">
            <image src="{{item}}" mode="aspectFill"/>
            <view class="evidence-del" data-type="settlement" data-index="{{index}}" bindtap="onDelEvidencePhoto">×</view>
          </view>
          <view class="evidence-add" wx:if="{{settlementPhotoUrls.length < 4}}" bindtap="onChooseSettlementPhoto">+</view>
        </view>
      </view>
      <view class="evidence-item">
        <text class="evidence-label fs-body">物料照片（至少1张）</text>
        <view class="evidence-grid">
          <view class="evidence-thumb" wx:for="{{materialPhotoUrls}}" wx:key="index">
            <image src="{{item}}" mode="aspectFill"/>
            <view class="evidence-del" data-type="material" data-index="{{index}}" bindtap="onDelEvidencePhoto">×</view>
          </view>
          <view class="evidence-add" wx:if="{{materialPhotoUrls.length < 4}}" bindtap="onChooseMaterialPhoto">+</view>
        </view>
      </view>
    </view>
  </view>

  <!-- 底部固定操作区 -->
  <view class="action-btns action-btns-fixed safe-area-bottom" wx:if="{{order && (order.status === 0 || order.status === 1)}}">
    <button class="btn-primary" wx:if="{{order.status === 0}}" disabled="{{accepting}}" bindtap="onAccept">{{accepting ? '处理中...' : '接单'}}</button>
    <button class="btn-primary" wx:if="{{order.status === 1}}" disabled="{{updating || planPendingConfirm}}" bindtap="onMarkComplete">{{planPendingConfirm ? '请等待车主确认维修方案' : (updating ? '处理中...' : '维修完成')}}</button>
  </view>
</view>
