<!-- 竞价报价页 - 03-竞价报价页 -->
<custom-nav-bar title="竞价报价" showBack="{{true}}" />
<view class="page-root bid-detail-page" style="{{pageRootStyle}}">
  <block wx:if="{{!hasToken}}">
    <view class="bid-empty card">
      <text class="text-muted fs-body">请先登录后查看报价</text>
      <navigator class="bid-login-link" url="/pages/auth/login/index?redirect={{redirectUrl}}">去登录</navigator>
    </view>
  </block>
  <block wx:elif="{{loading && !bidding}}">
    <view class="bid-loading">
      <text class="text-muted fs-body">加载中...</text>
    </view>
  </block>
  <block wx:elif="{{error}}">
    <view class="bid-error card">
      <text class="text-muted fs-body">{{error}}</text>
      <view class="bid-back-btn btn-secondary" bindtap="onBack">返回上一页</view>
    </view>
  </block>
  <block wx:elif="{{bidding}}">
    <scroll-view class="bid-scroll" scroll-y style="{{scrollStyle}}">
      <!-- 竞价状态 -->
      <view class="bid-status card">
        <view class="bid-status-row">
          <text class="text-muted fs-cap">剩余时间</text>
          <text class="fs-body fw-bold {{countdownExpired ? 'text-error' : 'text-primary'}}">{{countdownText}}</text>
        </view>
        <view class="bid-status-row">
          <text class="text-muted fs-cap">已报价</text>
          <text class="fs-body">{{bidding.quote_count}}家</text>
        </view>
      </view>

      <!-- AI 定损报告（可折叠） -->
      <view class="bid-report card" wx:if="{{bidding.analysis_result && ((bidding.analysis_result.damages && bidding.analysis_result.damages.length) || (bidding.analysis_result.total_estimate && bidding.analysis_result.total_estimate.length >= 2))}}">
        <view class="bid-report-head" bindtap="toggleReport">
          <text class="fs-body fw-bold">AI 定损报告</text>
          <image class="bid-report-arrow" src="/images/icon/zhedie.png" mode="aspectFit" style="transform: rotate({{reportExpanded ? 180 : 0}}deg);"/>
        </view>
        <view class="bid-report-body" wx:if="{{reportExpanded}}">
          <view class="bid-report-row" wx:if="{{bidding.analysis_result.total_estimate && bidding.analysis_result.total_estimate.length >= 2}}">
            <text class="text-muted fs-cap">预估费用</text>
            <text class="fs-body">{{bidding.analysis_result.total_estimate[0]}}-{{bidding.analysis_result.total_estimate[1]}} 元</text>
          </view>
          <view class="bid-report-damages" wx:if="{{bidding.analysis_result.damages && bidding.analysis_result.damages.length}}">
            <text class="fs-cap fw-bold">损伤部位</text>
            <view class="bid-damage-item" wx:for="{{bidding.analysis_result.damages}}" wx:key="index">
              <text class="fs-cap">{{item.part}}：{{item.type}}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- 支付方式（竞价提交后不可修改） -->
      <view class="bid-sort card">
        <text class="bid-sort-label text-muted fs-cap">支付方式</text>
        <text class="bid-sort-value fs-body fw-medium">{{bidding.insurance_info && bidding.insurance_info.is_insurance ? '保险支付' : '自费'}}</text>
      </view>

      <!-- 报价列表 -->
      <view class="bid-list" wx:if="{{quotes.length > 0}}">
        <view class="bid-disclaimer text-muted fs-cap">此报价仅供参考，以实际维修时为准</view>
        <view class="bid-quote card" wx:for="{{quotes}}" wx:key="quote_id">
          <view class="bid-quote-main">
            <image class="bid-quote-logo" src="{{item.logo || '/images/logo/logo_white.png'}}" mode="aspectFill"/>
            <view class="bid-quote-info">
              <text class="bid-quote-name fs-body fw-bold">{{item.shop_name}}</text>
              <view class="bid-quote-meta">
                <text class="text-muted fs-sm">{{item.starsFull}}{{item.starsEmpty}} {{item.rating}}分</text>
                <text class="text-muted fs-sm" wx:if="{{item.distance != null}}"> · {{item.distance}}km</text>
              </view>
              <view class="bid-quote-price">
                <text class="bid-quote-amount fs-h3 fw-bold text-gold">¥{{item.amountText}}</text>
                <text class="bid-quote-save text-success fs-cap" wx:if="{{item.saveText}}">{{item.saveText}}</text>
              </view>
              <view class="bid-quote-extra text-muted fs-cap">
                <text>工期 {{item.duration}}天</text>
                <text wx:if="{{item.warranty}}"> · 质保{{item.warranty}}月</text>
              </view>
              <view class="bid-quote-items-wrap" wx:if="{{(item.items && item.items.length > 0) || (item.value_added_services && item.value_added_services.length > 0)}}">
                <view class="bid-quote-items-btn" bindtap="onToggleQuoteItems" data-quote-id="{{item.quote_id}}">
                  <text class="bid-quote-items-btn-text">报价明细</text>
                  <text class="bid-quote-items-btn-arrow">{{expandedQuoteId === item.quote_id ? '▲' : '▼'}}</text>
                </view>
                <view class="bid-quote-items" wx:if="{{expandedQuoteId === item.quote_id}}">
                  <view class="bid-quote-item-row" wx:for="{{item.items}}" wx:for-item="sub" wx:key="index">
                    <text class="fs-sm">{{sub.damage_part || sub.name || sub.item}}</text>
                    <text class="fs-sm text-muted">{{sub.repair_type || '维修'}}{{sub.repair_type === '换' && sub.parts_type ? ' · ' + sub.parts_type : ''}}</text>
                  </view>
                  <view class="bid-quote-value-added" wx:if="{{item.value_added_services && item.value_added_services.length}}">
                    <text class="bid-quote-value-added-title fs-cap">增值服务</text>
                    <view class="bid-quote-value-added-item fs-sm" wx:for="{{item.value_added_services}}" wx:for-item="va" wx:key="index">{{va.name || va}}</view>
                  </view>
                  <text class="bid-quote-disclaimer text-muted fs-cap">此报价仅供参考，以实际维修时为准</text>
                </view>
              </view>
            </view>
          </view>
          <button
            class="bid-quote-btn btn-primary"
            disabled="{{countdownExpired || bidding.status !== 0 || selecting}}"
            loading="{{selecting && selectedShopId === item.shop_id}}"
            bindtap="onSelectTap"
            data-index="{{index}}"
          >选择</button>
        </view>
      </view>

      <!-- 无报价 -->
      <view class="bid-empty card" wx:elif="{{!loading && quotes.length === 0}}">
        <text class="text-muted fs-body">暂无报价，请等待维修厂报价或扩大范围</text>
        <view class="bid-dev-seed" bindtap="onSeedDevQuotes">
          <text class="brand-light fs-cap">生成测试报价（开发用）</text>
        </view>
      </view>

      <view class="bid-bottom-pad"></view>
    </scroll-view>

    <!-- 选择确认弹窗 -->
    <view class="bid-modal-mask" wx:if="{{showConfirm}}" bindtap="onCloseConfirm"></view>
    <view class="bid-modal card" wx:if="{{showConfirm}}">
      <view class="bid-modal-title fs-h3 fw-bold">确认选择</view>
      <view class="bid-modal-shop" wx:if="{{confirmQuote}}">
        <text class="fs-body fw-bold">{{confirmQuote.shop_name}}</text>
        <text class="fs-body text-gold">¥{{confirmQuote.amountText}}</text>
        <text class="text-muted fs-cap">工期 {{confirmQuote.duration}}天 · 质保{{confirmQuote.warranty}}月</text>
        <view class="bid-modal-items" wx:if="{{confirmQuote.items && confirmQuote.items.length > 0}}">
          <text class="fs-cap fw-bold">报价明细</text>
          <view class="bid-modal-item" wx:for="{{confirmQuote.items}}" wx:key="index">
            <text class="fs-sm">{{item.damage_part || item.name || item.item}}</text>
            <text class="fs-sm text-muted">{{item.repair_type || '维修'}}{{item.repair_type === '换' && item.parts_type ? ' · ' + item.parts_type : ''}}</text>
          </view>
        </view>
        <view class="bid-modal-items" wx:if="{{confirmQuote.value_added_services && confirmQuote.value_added_services.length}}">
          <text class="fs-cap fw-bold">增值服务</text>
          <view class="bid-modal-item" wx:for="{{confirmQuote.value_added_services}}" wx:key="index">
            <text class="fs-sm">{{item.name || item}}</text>
          </view>
        </view>
        <text class="bid-modal-disclaimer text-muted fs-cap">此报价仅供参考，以实际维修时为准</text>
      </view>
      <view class="bid-modal-actions">
        <view class="btn-secondary bid-modal-cancel" bindtap="onCloseConfirm">取消</view>
        <button class="btn-primary bid-modal-ok" loading="{{selecting}}" bindtap="onConfirmSelect">确认</button>
      </view>
    </view>
  </block>
</view>
