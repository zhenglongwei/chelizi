<!-- 维修厂详情页 - 04-维修厂详情页 -->
<custom-nav-bar title="维修厂详情" showBack="{{true}}" />
<view class="page-root shop-detail-page" style="{{pageRootStyle}}">
  <block wx:if="{{loading}}">
    <view class="detail-loading text-muted fs-body">加载中...</view>
  </block>
  <block wx:elif="{{shop}}">
    <scroll-view
      class="detail-scroll"
      scroll-y
      style="{{scrollStyle}}"
      bindscrolltolower="loadReviews"
    >
      <!-- 维修厂信息区 -->
      <view class="detail-header card">
        <view class="detail-top">
          <image class="detail-logo" src="{{shop.logo}}" mode="aspectFill"/>
          <view class="detail-main">
            <text class="detail-name text-primary fs-h3 fw-bold">{{shop.name}}</text>
            <view class="detail-rating">
              <text class="detail-stars text-star fs-cap">{{shop.starsFull}}{{shop.starsEmpty}}</text>
              <text class="detail-rating-txt text-muted fs-cap">{{shop.avgRating}}分 · {{shop.totalReviews}}条 · {{shop.total_orders}}单</text>
            </view>
            <view class="detail-tags" wx:if="{{shop.categories.length}}">
              <text class="detail-tag fs-cap" wx:for="{{shop.categories}}" wx:key="*this">{{item}}</text>
            </view>
          </view>
          <image
            class="detail-fav"
            src="{{favored ? '/images/icon/checked.png' : '/images/icon/unchecked.png'}}"
            mode="aspectFit"
            bindtap="onFavorite"
          />
        </view>
        <view class="detail-info">
          <view class="detail-row" wx:if="{{shop.address}}">
            <image class="detail-row-icon" src="/images/icon/location.png" mode="aspectFit"/>
            <text class="detail-row-txt text-muted fs-body">{{shop.address}}</text>
          </view>
          <view class="detail-row" wx:if="{{shop.business_hours}}">
            <image class="detail-row-icon" src="/images/icon/clock.png" mode="aspectFit"/>
            <text class="detail-row-txt text-muted fs-body">{{shop.business_hours}}</text>
          </view>
          <view class="detail-row" wx:if="{{shop.phone}}">
            <image class="detail-row-icon" src="/images/icon/phone.png" mode="aspectFit"/>
            <text class="detail-row-txt text-muted fs-body">{{shop.phone}}</text>
          </view>
        </view>
      </view>

      <!-- 历史偏差率 -->
      <view class="detail-section card" wx:if="{{shop.deviation_rate != null}}">
        <view class="detail-section-title fs-body fw-bold">报价偏差率</view>
        <view class="detail-deviation">
          <text class="detail-deviation-value {{shop.deviationClass}}">{{shop.deviationRate}}%</text>
          <text class="detail-deviation-desc text-muted fs-cap">历史报价与实际金额偏差，越低越准</text>
        </view>
      </view>

      <!-- 服务项目 -->
      <view class="detail-section card" wx:if="{{shop.services && shop.services.length}}">
        <view class="detail-section-title fs-body fw-bold">服务项目</view>
        <view class="detail-services">
          <view class="detail-service" wx:for="{{shop.services}}" wx:key="name">
            <text class="fs-body">{{item.name}}</text>
            <text class="text-muted fs-cap" wx:if="{{item.min_price || item.max_price}}">{{item.min_price || 0}}-{{item.max_price || 0}}元</text>
          </view>
        </view>
      </view>

      <!-- 评价汇总（与好评率脱钩，强调评价数量） -->
      <view class="detail-section card">
        <view class="detail-section-title fs-body fw-bold">用户评价</view>
        <view class="detail-review-summary" wx:if="{{shop.totalReviews > 0}}">
          <view class="detail-review-score">
            <text class="detail-score-num text-primary">{{shop.totalReviews}}</text>
            <text class="text-muted fs-cap">条评价</text>
          </view>
          <text class="text-weak fs-sm">按内容完整度、发布时间排序，与好评率脱钩</text>
        </view>
        <view class="detail-no-review text-muted fs-body" wx:else>暂无评价</view>
      </view>

      <!-- 评价列表 -->
      <view class="detail-section card" wx:if="{{reviews.length}}">
        <view class="detail-review-list">
          <view
            class="detail-review-item {{item.expanded ? 'detail-review-item-expanded' : ''}}"
            wx:for="{{reviews}}"
            wx:key="review_id"
            id="review-{{item.review_id}}"
            data-review-id="{{item.review_id}}"
          >
            <view class="detail-review-head">
              <text class="detail-review-user text-primary fs-body">{{item.user.nickname}}</text>
              <text class="detail-review-date text-weak fs-cap">{{item.dateText}}</text>
            </view>
            <view class="detail-review-stars text-star fs-cap" wx:if="{{item.rating}}">{{item.ratingText}}</view>
            <view class="detail-review-content-wrap">
              <text class="detail-review-content text-muted fs-body {{item.expanded ? '' : 'detail-review-content-collapsed'}}" wx:if="{{item.content}}">{{item.expanded ? item.content : item.contentPreview}}</text>
              <text class="detail-review-expand-btn text-primary fs-sm" wx:if="{{item.content && !item.expanded && item.content.length > 60}}" bindtap="onExpandReview" data-index="{{index}}">展开</text>
            </view>
            <view class="detail-review-images" wx:if="{{item.after_images && item.after_images.length}}">
              <image class="detail-review-img" wx:for="{{item.after_images}}" wx:for-item="img" wx:key="*this" src="{{img}}" mode="aspectFill" show-menu-by-longpress="{{true}}"/>
            </view>
            <view class="detail-review-badge text-weak fs-sm" wx:if="{{item.isLowRating}}">该用户已完成全部评价要求，全额领取对应奖励</view>
            <view class="detail-review-owner-verify text-danger fs-sm" wx:if="{{item.has_owner_verify_badge}}">车主验证・真实避坑</view>
            <view class="detail-review-actions">
              <view class="detail-review-like" bindtap="onLikeReview" data-index="{{index}}" data-review-id="{{item.review_id}}">
                <!-- 点赞图标：like.png 未点赞，liked.png 已点赞；若不存在需补充 -->
                <image class="detail-review-like-icon" src="{{item.liked ? '/images/icon/liked.png' : '/images/icon/like.png'}}" mode="aspectFit"/>
                <text class="text-muted fs-cap">{{item.like_count || 0}} 点赞</text>
                <text class="text-weak fs-sm" wx:if="{{item.post_verify_count > 0}}"> · {{item.post_verify_count}}位车主验证有用</text>
              </view>
            </view>
          </view>
        </view>
        <view class="detail-more text-muted fs-cap" wx:if="{{loadingReviews}}">加载更多...</view>
        <view class="detail-more text-muted fs-cap" wx:elif="{{!hasMoreReviews}}">— 没有更多了 —</view>
      </view>

      <view class="detail-bottom-pad"></view>
    </scroll-view>

    <!-- 底部操作栏 -->
    <view class="detail-footer">
      <view class="detail-footer-btn" bindtap="onCall">
        <image class="detail-footer-icon" src="/images/icon/phone.png" mode="aspectFit"/>
        <text class="fs-cap">电话</text>
      </view>
      <view class="detail-footer-btn" bindtap="onNavigate">
        <image class="detail-footer-icon" src="/images/icon/location.png" mode="aspectFit"/>
        <text class="fs-cap">导航</text>
      </view>
      <view class="detail-footer-btn detail-footer-book" bindtap="onBook">
        <text class="fs-body fw-bold">立即预约</text>
      </view>
    </view>
  </block>
</view>
