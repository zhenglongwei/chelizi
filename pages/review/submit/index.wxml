<!-- 主评价页 - 固定问题、材料、自主评价 -->
<custom-nav-bar title="评价" showBack="{{true}}" />
<view class="page-root review-page" style="{{pageRootStyle}}">
  <block wx:if="{{loading}}">
    <view class="review-loading"><text class="text-muted fs-body">加载中...</text></view>
  </block>
  <block wx:elif="{{error}}">
    <view class="review-error card">
      <text class="text-muted fs-body">{{error}}</text>
      <view class="review-back-btn" bindtap="onBack">返回</view>
    </view>
  </block>
  <block wx:elif="{{submitted}}">
    <view class="review-success card">
      <text class="fs-h3 fw-bold text-success">评价提交成功</text>
      <text class="fs-body text-muted" style="margin-top: var(--space-md);" wx:if="{{!isInvalidReview}}">奖励金 {{rewardAmount}} 元已到账</text>
      <text class="fs-body text-muted" style="margin-top: var(--space-md);" wx:elif="{{isInvalidReview}}">未达有效标准，无法获得奖励金。改进后可追评提升等级</text>
      <text class="fs-sm text-weak" style="margin-top: var(--space-sm);">随时可追评，有机会提升等级获得更多奖励金</text>
      <view class="review-success-actions">
        <button class="btn-primary" wx:if="{{reviewId}}" bindtap="onToFollowup">去追评</button>
        <button class="btn-primary" bindtap="onToOrder">查看订单</button>
        <button class="btn-secondary" bindtap="onToUser">返回个人中心</button>
      </view>
    </view>
  </block>
  <block wx:else>
    <!-- 顶部合规提示（固定，醒目） -->
    <view class="review-compliance review-compliance-highlight">
      <text class="review-compliance-text">奖励仅与评价内容的完整性、真实性挂钩，与评价正负倾向完全无关，差评达标也可全额领取奖励。</text>
    </view>

    <scroll-view class="review-scroll" scroll-y style="{{scrollStyle}}">
      <!-- 维修厂信息 -->
      <view class="review-section card">
        <view class="review-section-title fs-body fw-bold">维修厂</view>
        <text class="fs-body">{{info.shop_name || '维修厂'}}</text>
      </view>

      <!-- 系统核验结果（6项，用户不答） -->
      <view class="review-section card review-verification" wx:if="{{orderVerification}}">
        <view class="review-section-title fs-body fw-bold">系统已核验</view>
        <view class="review-verification-text {{orderVerificationAllOk ? 'text-success' : 'text-weak'}}">
          {{orderVerificationAllOk ? '报价与结算金额一致、无额外新增项目、服务商一致、工期与质保已核验，无异常' : '部分核验项需关注，请如实填写下方评价'}}
        </view>
      </view>

      <!-- 二、用户必答（3道） -->
      <view class="review-section card">
        <view class="review-section-title fs-body fw-bold">请回答以下问题</view>
        <view class="review-plan-compare" wx:if="{{planCompare && planCompare.hasDiff}}">
          <view class="review-plan-compare-title">维修方案有调整</view>
          <view class="review-plan-compare-row">
            <view class="review-plan-compare-col">
              <text class="review-plan-compare-label">原方案（下单时）</text>
              <view class="review-plan-compare-item" wx:for="{{planCompare.originalItems}}" wx:key="*this">{{item}}</view>
              <view class="review-plan-compare-meta" wx:if="{{planCompare.originalAmount != null || planCompare.originalDuration != null || planCompare.originalWarranty != null}}">金额 ¥{{planCompare.originalAmount || '-'}} · 工期{{planCompare.originalDuration || '-'}}天 · 质保{{planCompare.originalWarranty || '-'}}月</view>
            </view>
            <view class="review-plan-compare-col">
              <text class="review-plan-compare-label">最终方案（维修时）</text>
              <view class="review-plan-compare-item" wx:for="{{planCompare.finalItems}}" wx:key="*this">{{item}}</view>
              <view class="review-plan-compare-meta" wx:if="{{planCompare.finalAmount != null || planCompare.finalDuration != null || planCompare.finalWarranty != null}}">金额 ¥{{planCompare.finalAmount || '-'}} · 工期{{planCompare.finalDuration || '-'}}天 · 质保{{planCompare.finalWarranty || '-'}}月</view>
            </view>
          </view>
        </view>
        <view class="review-objective">
          <text class="fs-body">1. 维修过程中，修理厂有没有主动给你同步过维修进度？</text>
          <text class="text-weak fs-sm" style="display: block; margin-top: var(--space-xs);">比如配件到货、开始施工、发现新问题，都会提前跟你沟通</text>
          <radio-group bindchange="onQ1" class="review-radio-group">
            <label><radio value="true" checked="{{answers.q1_progress_synced === true}}"/>是</label>
            <label><radio value="false" checked="{{answers.q1_progress_synced === false}}"/>否</label>
          </radio-group>
        </view>
        <view class="review-objective">
          <text class="fs-body">2. 更换配件时，修理厂有没有给你展示新配件、以及换下来的旧配件？</text>
          <radio-group bindchange="onQ2" class="review-radio-group">
            <label><radio value="true" checked="{{answers.q2_parts_shown === true}}"/>是</label>
            <label><radio value="false" checked="{{answers.q2_parts_shown === false}}"/>否</label>
          </radio-group>
        </view>
        <view class="review-objective">
          <text class="fs-body">3. 修完车之后，你当初报修的车辆问题，已经完全解决了？</text>
          <radio-group bindchange="onQ3" class="review-radio-group">
            <label><radio value="true" checked="{{answers.q3_fault_resolved === true}}"/>是</label>
            <label><radio value="false" checked="{{answers.q3_fault_resolved === false}}"/>否</label>
          </radio-group>
        </view>
        <!-- 第3题选否时：用户举证故障凭证（选填，提升反馈权重） -->
        <view class="review-fault-evidence" wx:if="{{answers.q3_fault_resolved === false}}">
          <text class="fs-body">故障凭证（选填）</text>
          <text class="text-weak fs-sm" style="display: block; margin-top: var(--space-xs);">可上传故障灯实拍、异响录音/视频等，有助于提升反馈权重</text>
          <view class="review-upload-grid">
            <view class="review-upload-item" wx:for="{{module3.faultEvidenceDisplayList}}" wx:key="index">
              <image class="review-thumb" src="{{item.url || item}}" mode="aspectFill"/>
              <view class="review-del" data-index="{{index}}" bindtap="onM3DelFaultEvidence"><text class="review-del-text">×</text></view>
            </view>
            <view class="review-upload-btn" wx:if="{{!module3.faultEvidenceDisplayList || module3.faultEvidenceDisplayList.length < 5}}" bindtap="onM3ChooseFaultEvidence">
              <text class="review-add-text">+</text>
              <text class="text-muted fs-cap">添加</text>
            </view>
          </view>
        </view>
      </view>

      <!-- 二、材料 -->
      <view class="review-section card">
        <view class="review-section-title fs-body fw-bold">材料</view>
        <text class="text-weak fs-sm" style="display: block; margin-bottom: var(--space-md);">服务商已提供的材料不可修改或删除，您可添加更多</text>
        <view class="review-upload-row">
          <text class="fs-body">维修结算清单（选填）</text>
          <text class="text-weak fs-sm" style="display: block; margin-top: var(--space-xs);">盖有服务商公章的维修结算清单，材料为服务商义务，缺失不影响您的奖励金</text>
          <view class="review-upload-single" wx:if="{{!module3.settlement_list_image && !module3.settlement_list_url}}" bindtap="onM3ChooseSettlement">
            <text class="review-add-text">+</text>
            <text class="text-muted fs-cap">上传</text>
          </view>
          <view class="review-upload-item" wx:else>
            <image class="review-thumb" src="{{module3.settlement_list_image || module3.settlement_list_url}}" mode="aspectFill"/>
            <text class="review-source-tag" wx:if="{{module3.settlementFromMerchant}}">服务商</text>
            <view class="review-del" wx:if="{{!module3.settlementFromMerchant}}" bindtap="onM3DelSettlement"><text class="review-del-text">×</text></view>
          </view>
        </view>
        <view class="review-upload-row">
          <text class="fs-body">维修过程材料（选填）</text>
          <text class="text-weak fs-sm" style="display: block; margin-top: var(--space-xs);">材料为服务商义务，您可补充上传</text>
          <view class="review-upload-grid">
            <view class="review-upload-item" wx:for="{{module2.materialDisplayList}}" wx:key="index">
              <image class="review-thumb" src="{{item.url || item}}" mode="aspectFill"/>
              <text class="review-source-tag" wx:if="{{item.fromMerchant}}">服务商</text>
              <view class="review-del" wx:if="{{!item.fromMerchant}}" data-index="{{index}}" bindtap="onM2DelMaterial"><text class="review-del-text">×</text></view>
            </view>
            <view class="review-upload-btn" bindtap="onM2ChooseMaterial">
              <text class="review-add-text">+</text>
              <text class="text-muted fs-cap">添加</text>
            </view>
          </view>
        </view>
        <view class="review-upload-row">
          <text class="fs-body">完工实拍图（选填）</text>
          <text class="text-weak fs-sm" style="display: block; margin-top: var(--space-xs);">与维修项目匹配的完工实拍，材料为服务商义务</text>
          <view class="review-upload-grid">
            <view class="review-upload-item" wx:for="{{module3.completionDisplayList}}" wx:key="index">
              <image class="review-thumb" src="{{item.url || item}}" mode="aspectFill"/>
              <text class="review-source-tag" wx:if="{{item.fromMerchant}}">服务商</text>
              <view class="review-del" wx:if="{{!item.fromMerchant}}" data-index="{{index}}" bindtap="onM3DelCompletion"><text class="review-del-text">×</text></view>
            </view>
            <view class="review-upload-btn" wx:if="{{!module3.completionDisplayList || module3.completionDisplayList.length < 8}}" bindtap="onM3ChooseCompletion">
              <text class="review-add-text">+</text>
              <text class="text-muted fs-cap">添加</text>
            </view>
          </view>
        </view>
      </view>

      <!-- 三、自主评价 -->
      <view class="review-section card">
        <view class="review-section-title fs-body fw-bold">自主评价（必填）</view>
        <textarea class="review-textarea" placeholder="请至少写 1 句与维修项目相关的描述，如避坑提示、价格对比、服务细节等，便于其他车主参考" value="{{module3.content}}" bindinput="onM3Content" maxlength="500"/>
        <view class="review-section-title fs-body" style="margin-top: var(--space-md);">选填星级（不影响奖励）</view>
        <view class="review-sub-row" wx:for="{{ratingItems}}" wx:key="key">
          <text class="fs-sm">{{item.label}}</text>
          <view class="review-stars review-stars-sm">
            <text class="review-star {{s <= item.value ? 'filled' : ''}}" wx:for="{{[1,2,3,4,5]}}" wx:for-item="s" wx:key="*this" data-key="{{item.key}}" data-value="{{s}}" bindtap="onRatingTap">{{s <= item.value ? '★' : '☆'}}</text>
          </view>
        </view>
      </view>

      <!-- 奖励金预估 -->
      <view class="review-section card review-reward" wx:if="{{rewardPreview}}">
        <view class="review-section-title fs-body fw-bold">奖励金预估</view>
        <view class="review-reward-total">
          <text class="text-muted fs-sm">预计可获奖励金</text>
          <text class="fs-body text-gold fw-bold">¥{{rewardPreview.total_reward}}</text>
        </view>
      </view>

      <!-- 匿名 -->
      <view class="review-section card">
        <view class="review-anonymous">
          <text class="fs-body">匿名评价</text>
          <switch checked="{{isAnonymous}}" bindchange="onAnonymousChange" color="var(--primary)"/>
        </view>
      </view>

      <view class="review-bottom-pad"></view>
    </scroll-view>

    <view class="review-footer">
      <button class="btn-primary review-submit-btn" bindtap="onSubmit" disabled="{{submitting}}">
        {{submitting ? '提交中...' : '提交评价 (' + progressText + ')'}}
      </button>
    </view>
  </block>
</view>
